{"version":3,"file":"partial-hydration-reference-loader.js","names":["createNamedReference","name","moduleId","createDefaultReference","partialHydrationReferenceLoader","content","includes","references","hasClientExportDirective","url","pathToFileURL","resourcePath","href","replace","rootContext","walk","parse","ecmaVersion","sourceType","ExpressionStatement","plainAcornNode","node","directive","ExportNamedDeclaration","declaration","type","id","declarations","push","value","properties","element","elements","specifiers","length","specifier","exported","ExportDefaultDeclaration","AssignmentExpression","left","object","property","join","module","exports"],"sources":["../../../../src/utils/webpack/loaders/partial-hydration-reference-loader.ts"],"sourcesContent":["/* eslint-disable @babel/no-invalid-this */\nimport url from \"url\"\nimport { parse } from \"acorn-loose\"\nimport { simple as walk } from \"acorn-walk\"\nimport type { LoaderDefinitionFunction } from \"webpack\"\nimport type { Node } from \"acorn-loose\"\nimport type {\n  ExportNamedDeclaration,\n  ExportDefaultDeclaration,\n  AssignmentExpression,\n  Directive,\n} from \"estree\"\n\nfunction createNamedReference(name: string, moduleId: string): string {\n  return `export const ${name} = {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${moduleId}',\n    name: '${name}'\n  }`\n}\n\nfunction createDefaultReference(name: string, moduleId: string): string {\n  return `export default {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${moduleId}',\n    name: '${name}'\n  }`\n}\n\nconst partialHydrationReferenceLoader: LoaderDefinitionFunction<\n  Record<string, unknown>\n> = async function partialHydrationReferenceLoader(content) {\n  if (!content.includes(`client export`)) {\n    return content\n  }\n\n  const references: Array<string> = []\n  let hasClientExportDirective = false\n\n  const moduleId = url\n    .pathToFileURL(this.resourcePath)\n    .href.replace(this.rootContext.replace(/\\\\/g, `/`), ``)\n    .replace(/file:\\/{3,4}/g, `file://`)\n\n  walk(parse(content, { ecmaVersion: 2020, sourceType: `module` }), {\n    ExpressionStatement(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as Directive\n\n      if (node.directive === `client export`) {\n        hasClientExportDirective = true\n      }\n    },\n    ExportNamedDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportNamedDeclaration\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/esm-declaration.js`\n      switch (node?.declaration?.type) {\n        case `VariableDeclaration`:\n          for (const { id } of node.declaration.declarations || []) {\n            if (id.type === `Identifier` && id.name) {\n              references.push(createNamedReference(id.name, moduleId))\n            }\n\n            if (id.type === `ObjectPattern`) {\n              // @ts-ignore Wrong type\n              for (const { value } of id.properties) {\n                if (value.type === `Identifier` && value.name) {\n                  references.push(createNamedReference(value.name, moduleId))\n                }\n              }\n            }\n\n            if (id.type === `ArrayPattern`) {\n              for (const element of id.elements || []) {\n                if (element?.type === `Identifier` && element.name) {\n                  references.push(createNamedReference(element.name, moduleId))\n                }\n              }\n            }\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          if (\n            node.declaration.id?.type === `Identifier` &&\n            node.declaration.id.name\n          ) {\n            references.push(\n              createNamedReference(node.declaration.id.name, moduleId)\n            )\n          }\n          break\n      }\n\n      // Handle cases shown in `fixtures/esm-list.js`\n      if (node.specifiers.length) {\n        for (const specifier of node.specifiers) {\n          if (\n            specifier.type === `ExportSpecifier` &&\n            specifier.exported.type === `Identifier` &&\n            specifier.exported.name\n          ) {\n            if (specifier.exported.name === `default`) {\n              references.push(createDefaultReference(`default`, moduleId))\n            } else {\n              references.push(\n                createNamedReference(specifier.exported.name, moduleId)\n              )\n            }\n          }\n        }\n      }\n    },\n    ExportDefaultDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportDefaultDeclaration\n\n      if (!hasClientExportDirective) return\n\n      switch (node.declaration.type) {\n        // Handle cases shown in `fixtures/esm-default-expression.js`\n        case `Identifier`:\n          if (node.declaration.name) {\n            references.push(createDefaultReference(`default`, moduleId))\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          references.push(createDefaultReference(`default`, moduleId))\n          break\n      }\n    },\n    // TODO: Explore how to only walk top level tokens\n    AssignmentExpression(plainAcornNode) {\n      const node = plainAcornNode as unknown as AssignmentExpression\n      const { left } = node\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/cjs-exports.js`\n      if (\n        left?.type === `MemberExpression` &&\n        left?.object?.type === `Identifier` &&\n        left.object?.name === `exports` &&\n        left?.property?.type === `Identifier` &&\n        left.property?.name\n      ) {\n        references.push(createNamedReference(left.property.name, moduleId))\n      }\n    },\n  })\n\n  return references.join(`\\n`)\n}\n\nmodule.exports = partialHydrationReferenceLoader\n"],"mappings":"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"}