{"version":3,"file":"flags.js","names":["satisfiesSemvers","semverConstraints","result","every","packageName","semverConstraint","packageVersion","require","version","e","semver","satisfies","includePrerelease","activeFlags","name","env","command","telemetryId","experimental","description","includedFlags","testFitness","umbrellaIssue","v18Constraint","react","v0Constraint","requires","Number"],"sources":["../../src/utils/flags.ts"],"sourcesContent":["import _ from \"lodash\"\nimport semver from \"semver\"\n\n// Does this experiment run for only builds\ntype executingCommand = \"build\" | \"develop\" | \"all\"\n\nexport const satisfiesSemvers = (\n  semverConstraints: Record<string, string>\n): boolean => {\n  // Check each semver check for the flag.\n  // If any are false, then the flag doesn't pass\n  const result = _.toPairs(semverConstraints).every(\n    ([packageName, semverConstraint]) => {\n      let packageVersion: string\n      try {\n        packageVersion = require(`${packageName}/package.json`).version\n      } catch (e) {\n        return false\n      }\n\n      // We care if the semver check doesn't pass.\n      return semver.satisfies(packageVersion, semverConstraint, {\n        includePrerelease: true,\n      })\n    }\n  )\n\n  return result\n}\n\nexport type fitnessEnum = true | false | \"OPT_IN\" | \"LOCKED_IN\"\n\nexport interface IFlag {\n  name: string\n  env: string\n  description: string\n  command: executingCommand\n  /**\n   * Use string identifier to track enabled flag or false to disable any tracking (useful when flag becomes new defaults)\n   */\n  telemetryId: string | false\n  // Heuristics for deciding if a flag is experimental:\n  // - there are known bugs most people will encounter and that block being\n  // able to use Gatsby normally\n  // - very few people have tested the feature so we're not sure if we've\n  // uncovered even common problems.\n  //\n  // Flags should start as experimental but once all serious known bugs are\n  // resolved and ~50+ people have tested it, experimental should be set to\n  // false.\n  experimental: boolean\n  /**\n   * True means conditions for the feature are met and can be opted in by user.\n   *\n   * False means it'll be disabled despite the user setting it true e.g.\n   * it just won't work e.g. it doesn't have new enough version for something.\n   *\n   * OPT_IN means the gatsby will enable the flag (unless the user explicitly\n   * disables it.\n   *\n   * LOCKED_IN means that feature is enabled always (unless `noCI` condition is met).\n   * This is mostly to provide more meaningful terminal messages instead of removing\n   * flag from the flag list when users has the flag set in configuration\n   * (avoids showing unknown flag message and shows \"no longer needed\" message).\n   */\n  testFitness: (flag: IFlag) => fitnessEnum\n  /**\n   * Human-readable text explaining requirements for this feature to be available\n   * (e.g. requires Node 14+)\n   *\n   * It is shown to users when testFitness() returns `false` but flag is set in gatsby-config.js\n   */\n  requires?: string\n  includedFlags?: Array<string>\n  umbrellaIssue?: string\n  noCI?: boolean\n}\n\nconst activeFlags: Array<IFlag> = [\n  {\n    name: `FAST_DEV`,\n    env: `GATSBY_EXPERIMENTAL_FAST_DEV`,\n    command: `develop`,\n    telemetryId: `FastDev`,\n    experimental: false,\n    description: `Enable all experiments aimed at improving develop server start time & develop DX.`,\n    includedFlags: [`DEV_SSR`, `PRESERVE_FILE_DOWNLOAD_CACHE`],\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `DEV_SSR`,\n    env: `GATSBY_EXPERIMENTAL_DEV_SSR`,\n    command: `develop`,\n    telemetryId: `DevSsr`,\n    experimental: false,\n    description: `Server Side Render (SSR) pages on full reloads during develop. Helps you detect SSR bugs and fix them without needing to do full builds.`,\n    umbrellaIssue: `https://gatsby.dev/dev-ssr-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PRESERVE_FILE_DOWNLOAD_CACHE`,\n    env: `GATSBY_EXPERIMENTAL_PRESERVE_FILE_DOWNLOAD_CACHE`,\n    command: `all`,\n    telemetryId: `PreserveFileDownloadCache`,\n    experimental: false,\n    description: `Don't delete the downloaded files cache when changing gatsby-node.js & gatsby-config.js files.`,\n    umbrellaIssue: `https://gatsby.dev/cache-clearing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PARALLEL_SOURCING`,\n    env: `GATSBY_EXPERIMENTAL_PARALLEL_SOURCING`,\n    command: `all`,\n    telemetryId: `ParallelSourcing`,\n    experimental: true,\n    description: `Run all source plugins at the same time instead of serially. For sites with multiple source plugins, this can speedup sourcing and transforming considerably.`,\n    umbrellaIssue: `https://gatsby.dev/parallel-sourcing-feedback`,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `DETECT_NODE_MUTATIONS`,\n    env: `GATSBY_DETECT_NODE_MUTATIONS`,\n    command: `all`,\n    telemetryId: `DetectNodeMutations`,\n    description: `Diagnostic mode to log any attempts to mutate node directly. Helpful when debugging missing data problems. See https://gatsby.dev/debugging-missing-data for more details.`,\n    experimental: false,\n    testFitness: (): fitnessEnum => true,\n  },\n  {\n    name: `PARTIAL_HYDRATION`,\n    env: `GATSBY_PARTIAL_HYDRATION`,\n    command: `build`,\n    telemetryId: `PartialHydration`,\n    description: `Enable partial hydration to reduce Total Blocking Time and Time To Interactive `,\n    umbrellaIssue: `https://gatsby.dev/partial-hydration-umbrella-issue`,\n    experimental: true,\n    testFitness: (): fitnessEnum => {\n      const v18Constraint = {\n        react: `>=18.0.0`,\n      }\n      const v0Constraint = {\n        react: `^0.0.0`,\n      }\n\n      return (\n        _CFLAGS_.GATSBY_MAJOR === `5` &&\n        (satisfiesSemvers(v18Constraint) || satisfiesSemvers(v0Constraint))\n      )\n    },\n    requires:\n      Number(_CFLAGS_.GATSBY_MAJOR) < 5\n        ? `Partial hydration is only available in Gatsby V5. Please upgrade Gatsby.`\n        : `Partial hydration requires React 18+ to work.`,\n  },\n]\n\nexport default activeFlags\n"],"mappings":";;;;;;;;;AACA;;AAKO,MAAMA,gBAAgB,GAC3BC,iBAD8B,IAElB;EACZ;EACA;EACA,MAAMC,MAAM,GAAG,uBAAUD,iBAAV,EAA6BE,KAA7B,CACb,CAAC,CAACC,WAAD,EAAcC,gBAAd,CAAD,KAAqC;IACnC,IAAIC,cAAJ;;IACA,IAAI;MACFA,cAAc,GAAGC,OAAO,CAAE,GAAEH,WAAY,eAAhB,CAAP,CAAuCI,OAAxD;IACD,CAFD,CAEE,OAAOC,CAAP,EAAU;MACV,OAAO,KAAP;IACD,CANkC,CAQnC;;;IACA,OAAOC,eAAA,CAAOC,SAAP,CAAiBL,cAAjB,EAAiCD,gBAAjC,EAAmD;MACxDO,iBAAiB,EAAE;IADqC,CAAnD,CAAP;EAGD,CAbY,CAAf;EAgBA,OAAOV,MAAP;AACD,CAtBM;;;AAwEP,MAAMW,WAAyB,GAAG,CAChC;EACEC,IAAI,EAAG,UADT;EAEEC,GAAG,EAAG,8BAFR;EAGEC,OAAO,EAAG,SAHZ;EAIEC,WAAW,EAAG,SAJhB;EAKEC,YAAY,EAAE,KALhB;EAMEC,WAAW,EAAG,mFANhB;EAOEC,aAAa,EAAE,CAAE,SAAF,EAAa,8BAAb,CAPjB;EAQEC,WAAW,EAAE,MAAmB;AARlC,CADgC,EAWhC;EACEP,IAAI,EAAG,SADT;EAEEC,GAAG,EAAG,6BAFR;EAGEC,OAAO,EAAG,SAHZ;EAIEC,WAAW,EAAG,QAJhB;EAKEC,YAAY,EAAE,KALhB;EAMEC,WAAW,EAAG,0IANhB;EAOEG,aAAa,EAAG,qCAPlB;EAQED,WAAW,EAAE,MAAmB;AARlC,CAXgC,EAqBhC;EACEP,IAAI,EAAG,8BADT;EAEEC,GAAG,EAAG,kDAFR;EAGEC,OAAO,EAAG,KAHZ;EAIEC,WAAW,EAAG,2BAJhB;EAKEC,YAAY,EAAE,KALhB;EAMEC,WAAW,EAAG,gGANhB;EAOEG,aAAa,EAAG,4CAPlB;EAQED,WAAW,EAAE,MAAmB;AARlC,CArBgC,EA+BhC;EACEP,IAAI,EAAG,mBADT;EAEEC,GAAG,EAAG,uCAFR;EAGEC,OAAO,EAAG,KAHZ;EAIEC,WAAW,EAAG,kBAJhB;EAKEC,YAAY,EAAE,IALhB;EAMEC,WAAW,EAAG,+JANhB;EAOEG,aAAa,EAAG,+CAPlB;EAQED,WAAW,EAAE,MAAmB;AARlC,CA/BgC,EAyChC;EACEP,IAAI,EAAG,uBADT;EAEEC,GAAG,EAAG,8BAFR;EAGEC,OAAO,EAAG,KAHZ;EAIEC,WAAW,EAAG,qBAJhB;EAKEE,WAAW,EAAG,4KALhB;EAMED,YAAY,EAAE,KANhB;EAOEG,WAAW,EAAE,MAAmB;AAPlC,CAzCgC,EAkDhC;EACEP,IAAI,EAAG,mBADT;EAEEC,GAAG,EAAG,0BAFR;EAGEC,OAAO,EAAG,OAHZ;EAIEC,WAAW,EAAG,kBAJhB;EAKEE,WAAW,EAAG,iFALhB;EAMEG,aAAa,EAAG,qDANlB;EAOEJ,YAAY,EAAE,IAPhB;EAQEG,WAAW,EAAE,MAAmB;IAC9B,MAAME,aAAa,GAAG;MACpBC,KAAK,EAAG;IADY,CAAtB;IAGA,MAAMC,YAAY,GAAG;MACnBD,KAAK,EAAG;IADW,CAArB;IAIA,OACE,QAA2B,GAA3B,KACCxB,gBAAgB,CAACuB,aAAD,CAAhB,IAAmCvB,gBAAgB,CAACyB,YAAD,CADpD,CADF;EAID,CApBH;EAqBEC,QAAQ,EACNC,MAAM,KAAN,GAAgC,CAAhC,GACK,0EADL,GAEK;AAxBT,CAlDgC,CAAlC;eA8Eed,W"}