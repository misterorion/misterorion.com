{"version":3,"file":"partial-hydration.js","names":["PARTIAL_HYDRATION_CHUNK_REASON","PartialHydrationPlugin","name","_collectedCssModules","Set","_previousManifest","constructor","manifestPath","reporter","_manifestPath","_reporter","_generateManifest","compilation","rootContext","moduleGraph","chunkGraph","json","mapOriginalModuleToPotentiallyConcatanetedModule","Map","recordModule","id","module","exports","chunkIds","normalModule","moduleExports","forEach","originalExport","resolvedExport","chunks","modules","mod","buildInfo","rsc","normalizedModuleKey","createNormalizedModuleKey","resource","undefined","ClientModulesToRecord","recordModuleExports","childMap","set","exportInfo","getExportsInfo","isReexport","targetInfo","getTarget","has","get","push","export","newClientModules","chunkGroups","chunkGroup","chunk","chunkModules","getChunkModulesIterable","add","subMod","clientModule","incomingConnections","getIncomingConnections","connection","dependency","originalModule","resolvedMap","resolvedModule","getModuleChunksIterable","moduleId","getModuleId","Array","from","clear","addClientModuleEntries","compiler","clientModules","cssModules","visited","collectCssModules","type","outgoingConnections","getOutgoingConnections","asyncRequires","NormalModule","request","endsWith","dependencyBlock","getParentBlock","AsyncDependenciesBlock","chunkName","startsWith","originModule","includes","removeConnection","Error","clientSSRLoader","map","path","relative","options","context","userRequest","join","clientComponentEntryDep","webpack","EntryPlugin","createDependency","addEntry","entry","Promise","resolve","reject","oldEntry","entries","includeDependencies","hooks","call","addModuleTree","err","failedEntry","succeedEntry","e","console","log","apply","beforeCompile","tap","previousManifest","fs","existsSync","JSON","parse","readFileSync","error","panic","finishMake","tapPromise","parentCompilation","thisCompilation","normalModuleFactory","parserCallback","parser","program","ast","hasClientExportDirective","body","find","statement","directive","state","for","optimizeChunks","appChunk","modulesToInsertIntoApp","cssModule","usedInChunks","isInAnyChunk","_","sort","a","b","getPostOrderIndex","connectChunkAndModule","group","groupsIterable","getModulePostOrderIndex","setModulePostOrderIndex","_modulePostOrderIndices","size","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_REPORT","manifest","emitManifestPath","replace","emitAsset","sources","RawSource","stringify"],"sources":["../../../../src/utils/webpack/plugins/partial-hydration.ts"],"sourcesContent":["import * as path from \"path\"\nimport fs from \"fs-extra\"\nimport { createNormalizedModuleKey } from \"../utils/create-normalized-module-key\"\nimport webpack, {\n  Module,\n  NormalModule,\n  javascript,\n  Compilation,\n  Compiler,\n  AsyncDependenciesBlock,\n} from \"webpack\"\nimport type Reporter from \"gatsby-cli/lib/reporter\"\n\ninterface IModuleExport {\n  id: string\n  chunks: Array<string>\n  name: string\n}\n\ninterface IDirective {\n  directive?: string\n}\n\nexport const PARTIAL_HYDRATION_CHUNK_REASON = `PartialHydration client module`\n\n/**\n * inspiration and code mostly comes from https://github.com/facebook/react/blob/3f70e68cea8d2ed0f53d35420105ae20e22ce428/packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js\n */\nexport class PartialHydrationPlugin {\n  name = `PartialHydrationPlugin`\n\n  _manifestPath: string // Absolute path to where the manifest file should be written\n  _reporter: typeof Reporter\n\n  _collectedCssModules = new Set<webpack.Module>()\n  _previousManifest = {}\n\n  constructor(manifestPath: string, reporter: typeof Reporter) {\n    this._manifestPath = manifestPath\n    this._reporter = reporter\n  }\n\n  _generateManifest(\n    compilation: Compilation,\n    rootContext: string\n  ): Record<string, Record<string, IModuleExport>> {\n    const moduleGraph = compilation.moduleGraph\n    const chunkGraph = compilation.chunkGraph\n\n    const json: Record<string, Record<string, IModuleExport>> = {}\n    const mapOriginalModuleToPotentiallyConcatanetedModule = new Map()\n    // @see https://github.com/facebook/react/blob/3f70e68cea8d2ed0f53d35420105ae20e22ce428/packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js#L220-L252\n    const recordModule = (\n      id: string,\n      module: Module | NormalModule,\n      exports: Array<{ originalExport: string; resolvedExport: string }>,\n      chunkIds: Array<string>\n    ): void => {\n      const normalModule: NormalModule = module as NormalModule\n\n      const moduleExports: Record<string, IModuleExport> = {}\n      exports.forEach(({ originalExport, resolvedExport }) => {\n        moduleExports[originalExport] = {\n          id: id,\n          chunks: chunkIds,\n          name: resolvedExport,\n        }\n      })\n\n      // @ts-ignore\n      if (normalModule.modules) {\n        // @ts-ignore\n        normalModule.modules.forEach(mod => {\n          if (mod.buildInfo.rsc) {\n            const normalizedModuleKey = createNormalizedModuleKey(\n              mod.resource,\n              rootContext\n            )\n\n            if (normalizedModuleKey !== undefined) {\n              json[normalizedModuleKey] = moduleExports\n            }\n          }\n        })\n      } else {\n        if (normalModule.buildInfo.rsc) {\n          const normalizedModuleKey = createNormalizedModuleKey(\n            normalModule.resource,\n            rootContext\n          )\n\n          if (normalizedModuleKey !== undefined) {\n            json[normalizedModuleKey] = moduleExports\n          }\n        }\n      }\n    }\n\n    const ClientModulesToRecord: Map<\n      webpack.Module,\n      Map<\n        webpack.Module,\n        Array<{\n          originalExport: string\n          resolvedExport: string\n        }>\n      >\n    > = new Map()\n\n    function recordModuleExports(module): any {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const childMap = new Map()\n      ClientModulesToRecord.set(module, childMap)\n\n      for (const exportInfo of moduleGraph.getExportsInfo(module).exports) {\n        if (exportInfo.isReexport()) {\n          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n          const targetInfo = exportInfo.getTarget(moduleGraph)!\n          if (!childMap.has(targetInfo.module)) {\n            childMap.set(targetInfo.module, [])\n          }\n\n          childMap.get(targetInfo.module)?.push({\n            originalExport: exportInfo.name,\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n            resolvedExport: targetInfo.export![0],\n          })\n        } else {\n          if (!childMap.has(module)) {\n            childMap.set(module, [])\n          }\n\n          childMap.get(module)?.push({\n            originalExport: exportInfo.name,\n            resolvedExport: exportInfo.name,\n          })\n        }\n      }\n    }\n\n    const newClientModules = new Set<webpack.Module>()\n    compilation.chunkGroups.forEach(chunkGroup => {\n      chunkGroup.chunks.forEach((chunk: webpack.Chunk) => {\n        const chunkModules =\n          compilation.chunkGraph.getChunkModulesIterable(chunk)\n        for (const mod of chunkModules) {\n          if (mod.buildInfo.rsc) {\n            mapOriginalModuleToPotentiallyConcatanetedModule.set(mod, mod)\n            newClientModules.add(mod)\n          }\n\n          // @ts-ignore\n          if (mod.modules) {\n            // @ts-ignore\n            for (const subMod of mod.modules) {\n              if (subMod.buildInfo.rsc) {\n                mapOriginalModuleToPotentiallyConcatanetedModule.set(\n                  subMod,\n                  mod\n                )\n                newClientModules.add(mod)\n              }\n            }\n          }\n        }\n      })\n    })\n\n    for (const clientModule of newClientModules) {\n      recordModuleExports(clientModule)\n\n      const incomingConnections =\n        moduleGraph.getIncomingConnections(clientModule)\n\n      for (const connection of incomingConnections) {\n        if (connection.dependency) {\n          if (ClientModulesToRecord.has(connection.module)) {\n            continue\n          }\n\n          recordModuleExports(connection.module)\n        }\n      }\n    }\n\n    for (const [originalModule, resolvedMap] of ClientModulesToRecord) {\n      for (const [resolvedModule, exports] of resolvedMap) {\n        const chunkIds: Set<string> = new Set()\n\n        const chunks = chunkGraph.getModuleChunksIterable(resolvedModule)\n\n        for (const chunk of chunks) {\n          if (chunk.id) {\n            chunkIds.add(chunk.id as string)\n          }\n        }\n\n        const moduleId = chunkGraph.getModuleId(resolvedModule) as string\n        recordModule(moduleId, originalModule, exports, Array.from(chunkIds))\n      }\n    }\n\n    ClientModulesToRecord.clear()\n\n    return json\n  }\n\n  async addClientModuleEntries(\n    // @ts-ignore\n    compiler: Compiler,\n    compilation: Compilation\n  ): Promise<void> {\n    const clientModules: Array<webpack.NormalModule> = []\n    const cssModules = (this._collectedCssModules = new Set())\n\n    const visited = new Set<webpack.Module>()\n    function collectCssModules(module: webpack.Module): void {\n      if (visited.has(module)) {\n        return\n      }\n      visited.add(module)\n      if (module.buildInfo.rsc) {\n        return\n      }\n\n      if (module.type === `css/mini-extract`) {\n        cssModules.add(module)\n      }\n\n      const outgoingConnections =\n        compilation.moduleGraph.getOutgoingConnections(module)\n\n      for (const connection of outgoingConnections) {\n        if (connection.dependency) {\n          collectCssModules(connection.module)\n        }\n      }\n    }\n\n    let asyncRequires: NormalModule | null = null\n    for (const module of compilation.modules) {\n      if (module instanceof NormalModule) {\n        if (module.buildInfo.rsc) {\n          clientModules.push(module)\n        } else if (module.request.endsWith(`export=default`)) {\n          const incomingConnections =\n            compilation.moduleGraph.getIncomingConnections(module)\n\n          for (const connection of incomingConnections) {\n            if (connection.dependency) {\n              const dependencyBlock = compilation.moduleGraph.getParentBlock(\n                connection.dependency\n              )\n\n              if (\n                dependencyBlock instanceof AsyncDependenciesBlock &&\n                dependencyBlock?.chunkName?.startsWith(`slice---`)\n              ) {\n                continue\n              }\n\n              if (connection.originModule instanceof NormalModule) {\n                if (\n                  connection.originModule.resource.includes(`async-requires`)\n                ) {\n                  asyncRequires = connection.originModule\n\n                  // Remove page template \"import\" from async-requires.\n                  // Note that if other imports to a template will remain it will remain in the bundle:\n                  // that can happen if template is marked with \"use client\" or if other client component\n                  // will import it. We don't want to force remove template - we just want to remove the\n                  // import from async-requires and let webpack remove it rom the bundle (or rather just not add it)\n                  // if it's not used anywhere else\n                  compilation.moduleGraph.removeConnection(\n                    connection.dependency\n                  )\n                }\n              }\n            }\n          }\n\n          // find css modules that are imported by this module\n          collectCssModules(module)\n        }\n      }\n    }\n\n    if (!asyncRequires) {\n      throw new Error(`couldn't find async-requires module`)\n    }\n\n    const clientSSRLoader = `gatsby/dist/utils/webpack/loaders/client-components-requires-writer-loader?modules=${clientModules\n      .map(\n        module =>\n          `./` +\n          path.relative(\n            compilation.options.context as string,\n            module.userRequest\n          )\n      )\n      .join(`,`)}!`\n\n    const clientComponentEntryDep = webpack.EntryPlugin.createDependency(\n      clientSSRLoader,\n      {\n        name: `app`,\n      }\n    )\n    await this.addEntry(compilation, ``, clientComponentEntryDep, {\n      name: `app`,\n    })\n  }\n\n  addEntry(\n    compilation: Compilation,\n    context: string,\n    entry: any /* Dependency */,\n    options: {\n      name: string\n    } /* EntryOptions */\n  ): Promise<any> /* Promise<module> */ {\n    return new Promise((resolve, reject) => {\n      // @ts-ignore\n      try {\n        const oldEntry = compilation.entries.get(options.name)\n        if (!oldEntry) {\n          resolve(null)\n          return\n        }\n\n        oldEntry.includeDependencies.push(entry)\n        compilation.hooks.addEntry.call(entry, options)\n        compilation.addModuleTree(\n          {\n            context,\n            dependency: entry,\n          },\n          // @ts-ignore\n          (err: Error | undefined, module: any) => {\n            if (err) {\n              compilation.hooks.failedEntry.call(entry, options, err)\n              return reject(err)\n            }\n\n            compilation.hooks.succeedEntry.call(entry, options, module)\n            return resolve(module)\n          }\n        )\n      } catch (e) {\n        console.log({ e })\n        reject(e)\n      }\n    })\n  }\n\n  apply(compiler: webpack.Compiler): void {\n    // Restore manifest from the previous compilation, otherwise it will be wiped since files aren't visited on cached builds\n    compiler.hooks.beforeCompile.tap(this.name, () => {\n      try {\n        const previousManifest = fs.existsSync(this._manifestPath)\n\n        if (!previousManifest) {\n          return\n        }\n\n        this._previousManifest = JSON.parse(\n          fs.readFileSync(this._manifestPath, `utf-8`)\n        )\n      } catch (error) {\n        this._reporter.panic({\n          id: `80001`,\n          context: {},\n          error,\n        })\n      }\n    })\n\n    compiler.hooks.finishMake.tapPromise(this.name, async compilation => {\n      if (compilation.compiler.parentCompilation) {\n        // child compilation happen for css modules for example, we only care about the main compilation\n        return\n      }\n      await this.addClientModuleEntries(compiler, compilation)\n    })\n\n    compiler.hooks.thisCompilation.tap(\n      this.name,\n      (compilation, { normalModuleFactory }) => {\n        const parserCallback = (parser: javascript.JavascriptParser): void => {\n          parser.hooks.program.tap(this.name, ast => {\n            const hasClientExportDirective = ast.body.find(\n              statement =>\n                statement.type === `ExpressionStatement` &&\n                (statement as IDirective).directive === `use client`\n            )\n\n            const module = parser.state.module\n\n            if (hasClientExportDirective) {\n              // this metadata will be preserved on warm builds, so we don't need to force parse modules\n              // each time, as webpack will manage going through parsing of module is invalidated\n              module.buildInfo.rsc = true\n            }\n          })\n        }\n\n        normalModuleFactory.hooks.parser\n          .for(`javascript/auto`)\n          .tap(this.name, parserCallback)\n        normalModuleFactory.hooks.parser\n          .for(`javascript/esm`)\n          .tap(this.name, parserCallback)\n        normalModuleFactory.hooks.parser\n          .for(`javascript/dynamic`)\n          .tap(this.name, parserCallback)\n\n        // add dangling css modules to the app entry\n        compilation.hooks.optimizeChunks.tap(this.name, () => {\n          let appChunk: webpack.Chunk | null = null\n          for (const chunk of compilation.chunks) {\n            if (chunk.name === `app`) {\n              appChunk = chunk\n              break\n            }\n          }\n\n          if (!appChunk) {\n            throw new Error(`\"app\" chunk not found`)\n          }\n\n          const modulesToInsertIntoApp: Array<webpack.Module> = []\n\n          for (const cssModule of this._collectedCssModules) {\n            const usedInChunks =\n              compilation.chunkGraph.getModuleChunksIterable(cssModule)\n\n            let isInAnyChunk = false\n\n            for (const _ of usedInChunks) {\n              isInAnyChunk = true\n              break\n            }\n            if (!isInAnyChunk) {\n              modulesToInsertIntoApp.push(cssModule)\n            }\n          }\n\n          for (const cssModule of modulesToInsertIntoApp.sort(\n            (a, b) =>\n              compilation.moduleGraph.getPostOrderIndex(a) -\n              compilation.moduleGraph.getPostOrderIndex(b)\n          )) {\n            compilation.chunkGraph.connectChunkAndModule(appChunk, cssModule)\n\n            for (const group of appChunk.groupsIterable) {\n              if (!group.getModulePostOrderIndex(cssModule)) {\n                group.setModulePostOrderIndex(\n                  cssModule,\n                  // @ts-ignore\n                  group._modulePostOrderIndices.size + 1\n                )\n              }\n            }\n          }\n        })\n\n        // generate client components manifest\n        compilation.hooks.processAssets.tap(\n          {\n            name: this.name,\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_REPORT,\n          },\n          () => {\n            const manifest = this._generateManifest(\n              compilation,\n              compilation.options.context as string\n            )\n\n            /**\n             * `emitAsset` is unclear about what the path should be relative to and absolute paths don't work. This works so we'll go with that.\n             * @see {@link https://webpack.js.org/api/compilation-object/#emitasset}\n             */\n            const emitManifestPath = `..${this._manifestPath.replace(\n              compiler.context,\n              ``\n            )}`\n\n            compilation.emitAsset(\n              emitManifestPath,\n              new webpack.sources.RawSource(\n                JSON.stringify(\n                  { ...this._previousManifest, ...manifest },\n                  null,\n                  2\n                ),\n                false\n              )\n            )\n          }\n        )\n      }\n    )\n  }\n}\n"],"mappings":"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"}