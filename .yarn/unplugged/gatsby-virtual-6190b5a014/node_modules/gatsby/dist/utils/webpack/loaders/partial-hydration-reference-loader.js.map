{"version":3,"file":"partial-hydration-reference-loader.js","names":["createNamedReference","name","normalizedModuleKey","createDefaultReference","partialHydrationReferenceLoader","content","includes","references","hasClientExportDirective","createNormalizedModuleKey","resourcePath","rootContext","walk","parse","ecmaVersion","sourceType","ExpressionStatement","plainAcornNode","node","directive","ExportNamedDeclaration","declaration","type","id","declarations","push","value","properties","element","elements","specifiers","length","specifier","exported","ExportDefaultDeclaration","AssignmentExpression","left","object","property","join","module","exports"],"sources":["../../../../src/utils/webpack/loaders/partial-hydration-reference-loader.ts"],"sourcesContent":["/* eslint-disable @babel/no-invalid-this */\nimport { parse } from \"acorn-loose\"\nimport { simple as walk } from \"acorn-walk\"\nimport type { LoaderDefinitionFunction } from \"webpack\"\nimport type { Node } from \"acorn-loose\"\nimport type {\n  ExportNamedDeclaration,\n  ExportDefaultDeclaration,\n  AssignmentExpression,\n  Directive,\n} from \"estree\"\nimport { createNormalizedModuleKey } from \"../utils/create-normalized-module-key\"\n\nfunction createNamedReference(\n  name: string,\n  normalizedModuleKey: string\n): string {\n  return `export const ${name} = {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${normalizedModuleKey}',\n    name: '${name}'\n  }`\n}\n\nfunction createDefaultReference(\n  name: string,\n  normalizedModuleKey: string\n): string {\n  return `export default {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${normalizedModuleKey}',\n    name: '${name}'\n  }`\n}\n\nconst partialHydrationReferenceLoader: LoaderDefinitionFunction<\n  Record<string, unknown>\n> = async function partialHydrationReferenceLoader(content) {\n  if (!content.includes(`use client`)) {\n    return content\n  }\n\n  const references: Array<string> = []\n  let hasClientExportDirective = false\n\n  const normalizedModuleKey = createNormalizedModuleKey(\n    this.resourcePath,\n    this.rootContext\n  )\n\n  walk(parse(content, { ecmaVersion: 2020, sourceType: `module` }), {\n    ExpressionStatement(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as Directive\n\n      if (node.directive === `use client`) {\n        hasClientExportDirective = true\n      }\n    },\n    ExportNamedDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportNamedDeclaration\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/esm-declaration.js`\n      switch (node?.declaration?.type) {\n        case `VariableDeclaration`:\n          for (const { id } of node.declaration.declarations || []) {\n            if (id.type === `Identifier` && id.name) {\n              references.push(\n                createNamedReference(id.name, normalizedModuleKey)\n              )\n            }\n\n            if (id.type === `ObjectPattern`) {\n              // @ts-ignore Wrong type\n              for (const { value } of id.properties) {\n                if (value.type === `Identifier` && value.name) {\n                  references.push(\n                    createNamedReference(value.name, normalizedModuleKey)\n                  )\n                }\n              }\n            }\n\n            if (id.type === `ArrayPattern`) {\n              for (const element of id.elements || []) {\n                if (element?.type === `Identifier` && element.name) {\n                  references.push(\n                    createNamedReference(element.name, normalizedModuleKey)\n                  )\n                }\n              }\n            }\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          if (\n            node.declaration.id?.type === `Identifier` &&\n            node.declaration.id.name\n          ) {\n            references.push(\n              createNamedReference(\n                node.declaration.id.name,\n                normalizedModuleKey\n              )\n            )\n          }\n          break\n      }\n\n      // Handle cases shown in `fixtures/esm-list.js`\n      if (node.specifiers.length) {\n        for (const specifier of node.specifiers) {\n          if (\n            specifier.type === `ExportSpecifier` &&\n            specifier.exported.type === `Identifier` &&\n            specifier.exported.name\n          ) {\n            if (specifier.exported.name === `default`) {\n              references.push(\n                createDefaultReference(`default`, normalizedModuleKey)\n              )\n            } else {\n              references.push(\n                createNamedReference(\n                  specifier.exported.name,\n                  normalizedModuleKey\n                )\n              )\n            }\n          }\n        }\n      }\n    },\n    ExportDefaultDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportDefaultDeclaration\n\n      if (!hasClientExportDirective) return\n\n      switch (node.declaration.type) {\n        // Handle cases shown in `fixtures/esm-default-expression.js`\n        case `Identifier`:\n          if (node.declaration.name) {\n            references.push(\n              createDefaultReference(`default`, normalizedModuleKey)\n            )\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          references.push(\n            createDefaultReference(`default`, normalizedModuleKey)\n          )\n          break\n      }\n    },\n    // TODO: Explore how to only walk top level tokens\n    AssignmentExpression(plainAcornNode) {\n      const node = plainAcornNode as unknown as AssignmentExpression\n      const { left } = node\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/cjs-exports.js`\n      if (\n        left?.type === `MemberExpression` &&\n        left?.object?.type === `Identifier` &&\n        left.object?.name === `exports` &&\n        left?.property?.type === `Identifier` &&\n        left.property?.name\n      ) {\n        references.push(\n          createNamedReference(left.property.name, normalizedModuleKey)\n        )\n      }\n    },\n  })\n\n  return hasClientExportDirective ? references.join(`\\n`) : content\n}\n\nmodule.exports = partialHydrationReferenceLoader\n"],"mappings":"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"}