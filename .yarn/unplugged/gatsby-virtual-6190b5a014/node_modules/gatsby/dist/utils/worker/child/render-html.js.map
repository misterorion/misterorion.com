{"version":3,"file":"render-html.js","names":["join","path","posix","lastSessionId","htmlComponentRenderer","webpackStats","resourcesForTemplateCache","Map","inFlightResourcesForTemplate","readStaticQueryContext","templatePath","filePath","process","cwd","rawSQContext","fs","readFile","JSON","parse","clearCaches","clearStaticQueryCaches","clear","clearAssetsMappingCache","doGetResourcesForTemplate","pageData","scriptsAndStyles","getScriptsAndStylesForTemplate","componentChunkName","staticQueryContext","getStaticQueryContext","staticQueryHashes","getResourcesForTemplate","memoizedResourcesForTemplate","get","inFlight","doWorkPromise","set","resources","delete","truncateObjStrings","obj","key","length","renderHTMLProd","htmlComponentRendererPath","paths","envVars","sessionId","webpackCompilationHash","publicDir","isPreview","env","GATSBY_IS_PREVIEW","unsafeBuiltinsUsageByPagePath","previewErrors","allSlicesProps","forEach","value","require","readWebpackStats","global","unsafeBuiltinUsage","Bluebird","map","pagePath","readPageData","resourcesForTemplate","html","unsafeBuiltinsUsage","sliceData","default","context","isDuringBuild","outputFile","generateHtmlPath","e","htmlRenderError","truncatedPageData","stack","stringify","name","message","code","concurrency","slicesPropsPerPage","renderHTMLDev","outputDir","htmlString","renderPartialHydrationProd","pathPrefix","Set","slicesMap","sliceName","Object","values","sliceDataPath","readJSON","staticQueryHash","add","Array","from","pageRenderer","getPageChunk","StaticQueryContext","renderToPipeableStream","React","chunk","outputPath","generatePageDataPath","replace","stream","createWriteStream","prefixedPagePath","pathname","search","split","pipe","createElement","Provider","ServerLocation","url","data","result","pageContext","location","hash","readFileSync","onError","error","partialHydrationError","emit","Promise","resolve","reject","on","renderSlices","slices","slicesProps","sliceId","props","hasChildren","sliceEntry","find","f","Error","_fileName","slice","MAGIC_CHILDREN_STRING","readSliceData","renderSlice","children","index","htmlChunk","ensureFileContent","err","renderSliceError","sliceProps"],"sources":["../../../../src/utils/worker/child/render-html.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-namespace */\n\nimport fs from \"fs-extra\"\nimport Bluebird from \"bluebird\"\nimport * as path from \"path\"\nimport { generateHtmlPath } from \"gatsby-core-utils/page-html\"\nimport { generatePageDataPath } from \"gatsby-core-utils/page-data\"\nimport { truncate } from \"lodash\"\n\nimport {\n  readWebpackStats,\n  getScriptsAndStylesForTemplate,\n  clearCache as clearAssetsMappingCache,\n} from \"../../client-assets-for-template\"\nimport {\n  IPageDataWithQueryResult,\n  readPageData,\n  readSliceData,\n} from \"../../page-data\"\nimport type { IRenderHtmlResult } from \"../../../commands/build-html\"\nimport {\n  clearStaticQueryCaches,\n  IResourcesForTemplate,\n  getStaticQueryContext,\n} from \"../../static-query-utils\"\nimport { ServerLocation } from \"@gatsbyjs/reach-router\"\nimport { IGatsbySlice } from \"../../../internal\"\nimport { ensureFileContent } from \"../../ensure-file-content\"\n// we want to force posix-style joins, so Windows doesn't produce backslashes for urls\nconst { join } = path.posix\n\ntype IUnsafeBuiltinUsage = Array<string> | undefined\n\ndeclare global {\n  namespace NodeJS {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    interface Global {\n      unsafeBuiltinUsage: IUnsafeBuiltinUsage\n    }\n  }\n}\n\ninterface IRenderHTMLError extends Error {\n  message: string\n  name: string\n  code?: string\n  stack?: string\n  context?: {\n    path?: string\n    unsafeBuiltinsUsageByPagePath?: Record<string, IUnsafeBuiltinUsage>\n  }\n}\n\n/**\n * Used to track if renderHTMLProd / renderHTMLDev are called within same \"session\" (from same renderHTMLQueue call).\n * As long as sessionId remains the same we can rely on memoized/cached resources for templates, css file content for inlining and static query results.\n * If session changes we invalidate our memoization caches.\n */\nlet lastSessionId = 0\nlet htmlComponentRenderer\nlet webpackStats\n\nconst resourcesForTemplateCache = new Map<string, IResourcesForTemplate>()\nconst inFlightResourcesForTemplate = new Map<\n  string,\n  Promise<IResourcesForTemplate>\n>()\n\nconst readStaticQueryContext = async (\n  templatePath: string\n): Promise<Record<string, { data: unknown }>> => {\n  const filePath = path.join(\n    // TODO: Better way to get this?\n    process.cwd(),\n    `.cache`,\n    `page-ssr`,\n    `sq-context`,\n    templatePath,\n    `sq-context.json`\n  )\n  const rawSQContext = await fs.readFile(filePath, `utf-8`)\n\n  return JSON.parse(rawSQContext)\n}\n\nfunction clearCaches(): void {\n  clearStaticQueryCaches()\n  resourcesForTemplateCache.clear()\n  inFlightResourcesForTemplate.clear()\n\n  clearAssetsMappingCache()\n}\n\nasync function doGetResourcesForTemplate(\n  pageData: IPageDataWithQueryResult\n): Promise<IResourcesForTemplate> {\n  const scriptsAndStyles = await getScriptsAndStylesForTemplate(\n    pageData.componentChunkName,\n    webpackStats\n  )\n\n  const { staticQueryContext } = await getStaticQueryContext(\n    pageData.staticQueryHashes\n  )\n\n  return {\n    staticQueryContext,\n    ...scriptsAndStyles,\n  }\n}\n\nasync function getResourcesForTemplate(\n  pageData: IPageDataWithQueryResult\n): Promise<IResourcesForTemplate> {\n  const memoizedResourcesForTemplate = resourcesForTemplateCache.get(\n    pageData.componentChunkName\n  )\n  if (memoizedResourcesForTemplate) {\n    return memoizedResourcesForTemplate\n  }\n\n  const inFlight = inFlightResourcesForTemplate.get(pageData.componentChunkName)\n  if (inFlight) {\n    return inFlight\n  }\n\n  const doWorkPromise = doGetResourcesForTemplate(pageData)\n  inFlightResourcesForTemplate.set(pageData.componentChunkName, doWorkPromise)\n\n  const resources = await doWorkPromise\n\n  resourcesForTemplateCache.set(pageData.componentChunkName, resources)\n  inFlightResourcesForTemplate.delete(pageData.componentChunkName)\n\n  return resources\n}\n\nconst truncateObjStrings = (obj): IPageDataWithQueryResult => {\n  // Recursively truncate strings nested in object\n  // These objs can be quite large, but we want to preserve each field\n  for (const key in obj) {\n    if (typeof obj[key] === `object` && obj[key] !== null) {\n      truncateObjStrings(obj[key])\n    } else if (typeof obj[key] === `string`) {\n      obj[key] = truncate(obj[key], { length: 250 })\n    }\n  }\n\n  return obj\n}\n\nexport const renderHTMLProd = async ({\n  htmlComponentRendererPath,\n  paths,\n  envVars,\n  sessionId,\n  webpackCompilationHash,\n}: {\n  htmlComponentRendererPath: string\n  paths: Array<string>\n  envVars: Array<[string, string | undefined]>\n  sessionId: number\n  webpackCompilationHash: string\n}): Promise<IRenderHtmlResult> => {\n  const publicDir = join(process.cwd(), `public`)\n  const isPreview = process.env.GATSBY_IS_PREVIEW === `true`\n\n  const unsafeBuiltinsUsageByPagePath = {}\n  const previewErrors = {}\n  const allSlicesProps = {}\n\n  // Check if we need to do setup and cache clearing. Within same session we can reuse memoized data,\n  // but it's not safe to reuse them in different sessions. Check description of `lastSessionId` for more details\n  if (sessionId !== lastSessionId) {\n    clearCaches()\n\n    // This is being executed in child process, so we need to set some vars\n    // for modules that aren't bundled by webpack.\n    envVars.forEach(([key, value]) => (process.env[key] = value))\n\n    htmlComponentRenderer = require(htmlComponentRendererPath)\n\n    webpackStats = await readWebpackStats(publicDir)\n\n    lastSessionId = sessionId\n\n    if (global.unsafeBuiltinUsage && global.unsafeBuiltinUsage.length > 0) {\n      unsafeBuiltinsUsageByPagePath[`__import_time__`] =\n        global.unsafeBuiltinUsage\n    }\n  }\n\n  await Bluebird.map(\n    paths,\n    async pagePath => {\n      try {\n        const pageData = await readPageData(publicDir, pagePath)\n        const resourcesForTemplate = await getResourcesForTemplate(pageData)\n\n        const { html, unsafeBuiltinsUsage, sliceData } =\n          await htmlComponentRenderer.default({\n            pagePath,\n            pageData,\n            webpackCompilationHash,\n            context: {\n              isDuringBuild: true,\n            },\n            ...resourcesForTemplate,\n          })\n\n        allSlicesProps[pagePath] = sliceData\n\n        if (unsafeBuiltinsUsage.length > 0) {\n          unsafeBuiltinsUsageByPagePath[pagePath] = unsafeBuiltinsUsage\n        }\n\n        await fs.outputFile(generateHtmlPath(publicDir, pagePath), html)\n      } catch (e) {\n        if (e.unsafeBuiltinsUsage && e.unsafeBuiltinsUsage.length > 0) {\n          unsafeBuiltinsUsageByPagePath[pagePath] = e.unsafeBuiltinsUsage\n        }\n\n        const htmlRenderError: IRenderHTMLError = e\n\n        htmlRenderError.context = {\n          path: pagePath,\n          unsafeBuiltinsUsageByPagePath,\n        }\n\n        // If we're in Preview-mode, write out a simple error html file.\n        if (isPreview) {\n          const pageData = await readPageData(publicDir, pagePath)\n          const truncatedPageData = truncateObjStrings(pageData)\n\n          const html = `<h1>Preview build error</h1>\n        <p>There was an error when building the preview page for this page (\"${pagePath}\").</p>\n        <h3>Error</h3>\n        <pre><code>${htmlRenderError?.stack}</code></pre>\n        <h3>Page component id</h3>\n        <p><code>${pageData.componentChunkName}</code></p>\n        <h3>Page data</h3>\n        <pre><code>${JSON.stringify(truncatedPageData, null, 4)}</code></pre>`\n\n          await fs.outputFile(generateHtmlPath(publicDir, pagePath), html)\n          previewErrors[pagePath] = {\n            e: htmlRenderError,\n            name: htmlRenderError.name,\n            message: htmlRenderError.message,\n            code: htmlRenderError?.code,\n            stack: htmlRenderError?.stack,\n          }\n        } else {\n          throw e\n        }\n      }\n    },\n    { concurrency: 2 }\n  )\n\n  return {\n    unsafeBuiltinsUsageByPagePath,\n    previewErrors,\n    slicesPropsPerPage: allSlicesProps,\n  }\n}\n\n// TODO: remove when DEV_SSR is done\nexport const renderHTMLDev = async ({\n  htmlComponentRendererPath,\n  paths,\n  envVars,\n  sessionId,\n}: {\n  htmlComponentRendererPath: string\n  paths: Array<string>\n  envVars: Array<[string, string | undefined]>\n  sessionId: number\n}): Promise<Array<unknown>> => {\n  const outputDir = join(process.cwd(), `.cache`, `develop-html`)\n\n  // Check if we need to do setup and cache clearing. Within same session we can reuse memoized data,\n  // but it's not safe to reuse them in different sessions. Check description of `lastSessionId` for more details\n  if (sessionId !== lastSessionId) {\n    clearCaches()\n\n    // This is being executed in child process, so we need to set some vars\n    // for modules that aren't bundled by webpack.\n    envVars.forEach(([key, value]) => (process.env[key] = value))\n\n    htmlComponentRenderer = require(htmlComponentRendererPath)\n\n    lastSessionId = sessionId\n  }\n\n  return Bluebird.map(\n    paths,\n    async pagePath => {\n      try {\n        const htmlString = await htmlComponentRenderer.default({\n          pagePath,\n          context: {\n            isDuringBuild: true,\n          },\n        })\n        return fs.outputFile(generateHtmlPath(outputDir, pagePath), htmlString)\n      } catch (e) {\n        // add some context to error so we can display more helpful message\n        e.context = {\n          path: pagePath,\n        }\n        throw e\n      }\n    },\n    { concurrency: 2 }\n  )\n}\n\nexport async function renderPartialHydrationProd({\n  paths,\n  envVars,\n  sessionId,\n  pathPrefix,\n}: {\n  paths: Array<string>\n  envVars: Array<[string, string | undefined]>\n  sessionId: number\n  pathPrefix\n}): Promise<void> {\n  const publicDir = join(process.cwd(), `public`)\n\n  const unsafeBuiltinsUsageByPagePath = {}\n\n  // Check if we need to do setup and cache clearing. Within same session we can reuse memoized data,\n  // but it's not safe to reuse them in different sessions. Check description of `lastSessionId` for more details\n  if (sessionId !== lastSessionId) {\n    clearCaches()\n\n    // This is being executed in child process, so we need to set some vars\n    // for modules that aren't bundled by webpack.\n    envVars.forEach(([key, value]) => (process.env[key] = value))\n\n    webpackStats = await readWebpackStats(publicDir)\n\n    lastSessionId = sessionId\n\n    if (global.unsafeBuiltinUsage && global.unsafeBuiltinUsage.length > 0) {\n      unsafeBuiltinsUsageByPagePath[`__import_time__`] =\n        global.unsafeBuiltinUsage\n    }\n  }\n\n  for (const pagePath of paths) {\n    const pageData = await readPageData(publicDir, pagePath)\n\n    // we collect static query hashes from page template and also all used slices on the page\n    const staticQueryHashes = new Set(pageData.staticQueryHashes)\n    if (pageData.slicesMap) {\n      for (const sliceName of Object.values(pageData.slicesMap)) {\n        const sliceDataPath = path.join(\n          publicDir,\n          `slice-data`,\n          `${sliceName}.json`\n        )\n        const sliceData = await fs.readJSON(sliceDataPath)\n        for (const staticQueryHash of sliceData.staticQueryHashes) {\n          staticQueryHashes.add(staticQueryHash)\n        }\n      }\n    }\n\n    const { staticQueryContext } = await getStaticQueryContext(\n      Array.from(staticQueryHashes)\n    )\n\n    const pageRenderer = path.join(\n      process.cwd(),\n      `.cache`,\n      `partial-hydration`,\n      `render-page`\n    )\n\n    const {\n      getPageChunk,\n      StaticQueryContext,\n      renderToPipeableStream,\n      React,\n    } = require(pageRenderer)\n    const chunk = await getPageChunk({\n      componentChunkName: pageData.componentChunkName,\n    })\n    const outputPath = generatePageDataPath(\n      path.join(process.cwd(), `public`),\n      pagePath\n    ).replace(`.json`, `-rsc.json`)\n\n    const stream = fs.createWriteStream(outputPath)\n\n    const prefixedPagePath = pathPrefix\n      ? `${pathPrefix}${pageData.path}`\n      : pageData.path\n    const [pathname, search = ``] = prefixedPagePath.split(`?`)\n\n    const { pipe } = renderToPipeableStream(\n      React.createElement(\n        StaticQueryContext.Provider,\n        { value: staticQueryContext },\n        [\n          // Make `useLocation` hook usuable in children\n          React.createElement(\n            ServerLocation,\n            { key: `partial-hydration-server-location`, url: pageData.path },\n            [\n              React.createElement(chunk.default, {\n                key: `partial-hydration-page`,\n                data: pageData.result.data,\n                pageContext: pageData.result.pageContext,\n                // Make location available to page as props, logic extracted from `LocationProvider`\n                location: {\n                  pathname,\n                  search,\n                  hash: ``,\n                },\n              }),\n            ]\n          ),\n        ]\n      ),\n      JSON.parse(\n        fs.readFileSync(\n          path.join(\n            process.cwd(),\n            `.cache`,\n            `partial-hydration`,\n            `manifest.json`\n          ),\n          `utf8`\n        )\n      ),\n      {\n        // React spits out the error here and does not emit it, we want to emit it\n        // so we can reject with the error and handle it upstream\n        onError: error => {\n          const partialHydrationError: IRenderHTMLError = error\n\n          partialHydrationError.context = {\n            path: pagePath,\n            unsafeBuiltinsUsageByPagePath,\n          }\n\n          stream.emit(`error`, error)\n        },\n      }\n    )\n\n    await new Promise<void>((resolve, reject) => {\n      stream.on(`error`, (error: IRenderHTMLError) => {\n        reject(error)\n      })\n\n      stream.on(`close`, () => {\n        resolve()\n      })\n\n      pipe(stream)\n    })\n  }\n}\n\nexport interface IRenderSliceResult {\n  chunks: 2 | 1\n}\n\nexport interface IRenderSlicesResults {\n  [sliceName: string]: IRenderSliceResult\n}\n\nexport interface ISlicePropsEntry {\n  sliceId: string\n  sliceName: string\n  props: Record<string, unknown>\n  hasChildren: boolean\n}\n\ninterface IRenderSliceHTMLError extends Error {\n  message: string\n  name: string\n  code?: string\n  stack?: string\n  context?: {\n    sliceName?: string\n    sliceData: unknown\n    sliceProps: unknown\n  }\n}\n\nexport async function renderSlices({\n  slices,\n  htmlComponentRendererPath,\n  publicDir,\n  slicesProps,\n}: {\n  publicDir: string\n  slices: Array<[string, IGatsbySlice]>\n  slicesProps: Array<ISlicePropsEntry>\n  htmlComponentRendererPath: string\n}): Promise<void> {\n  const htmlComponentRenderer = require(htmlComponentRendererPath)\n\n  for (const { sliceId, props, sliceName, hasChildren } of slicesProps) {\n    const sliceEntry = slices.find(f => f[0] === sliceName)\n    if (!sliceEntry) {\n      throw new Error(\n        `Slice name \"${sliceName}\" not found when rendering slices`\n      )\n    }\n\n    const [_fileName, slice] = sliceEntry\n\n    const staticQueryContext = await readStaticQueryContext(\n      slice.componentChunkName\n    )\n\n    const MAGIC_CHILDREN_STRING = `__DO_NOT_USE_OR_ELSE__`\n    const sliceData = await readSliceData(publicDir, slice.name)\n\n    try {\n      const html = await htmlComponentRenderer.renderSlice({\n        slice,\n        staticQueryContext,\n        props: {\n          data: sliceData?.result?.data,\n          ...(hasChildren ? { children: MAGIC_CHILDREN_STRING } : {}),\n          ...props,\n        },\n      })\n      const split = html.split(MAGIC_CHILDREN_STRING)\n\n      // TODO always generate both for now\n      let index = 1\n      for (const htmlChunk of split) {\n        await ensureFileContent(\n          path.join(publicDir, `_gatsby`, `slices`, `${sliceId}-${index}.html`),\n          htmlChunk\n        )\n        index++\n      }\n    } catch (err) {\n      const renderSliceError: IRenderSliceHTMLError = err\n      renderSliceError.context = {\n        sliceName,\n        sliceData,\n        sliceProps: props,\n      }\n      throw renderSliceError\n    }\n  }\n}\n"],"mappings":"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"}