{"version":3,"file":"validate-component.js","names":["validationCache","Set","isNotTestEnv","process","env","NODE_ENV","isProductionEnv","validateComponent","args","input","pluginName","errorIdMap","component","error","id","noPath","context","componentPath","getPathToLayoutComponent","errorContext","has","path","isAbsolute","notAbsolute","fs","existsSync","doesNotExist","includes","fileContent","readFileSync","empty","panicOnBuild","extname","includesDefaultExport","match","noDefaultExport","add","clearValidationCache","clear"],"sources":["../../src/utils/validate-component.ts"],"sourcesContent":["import path from \"path\"\nimport fs from \"fs-extra\"\nimport { getPathToLayoutComponent } from \"gatsby-core-utils/parse-component-path\"\nimport { IPageInput as ICreatePageInput } from \"../redux/actions/public\"\nimport { ICreateSliceInput } from \"../redux/actions/restricted\"\n\nconst validationCache = new Set<string>()\n\ninterface IErrorMeta {\n  id: string\n  context: Record<string, unknown>\n}\n\ninterface IErrorIdMap {\n  noPath: string\n  notAbsolute: string\n  doesNotExist: string\n  empty: string\n  noDefaultExport: string\n}\n\nconst isNotTestEnv = process.env.NODE_ENV !== `test`\nconst isProductionEnv = process.env.NODE_ENV === `production`\n\nexport function validateComponent(args: {\n  input: ICreatePageInput | ICreateSliceInput\n  pluginName: string\n  errorIdMap: IErrorIdMap\n}): { error?: IErrorMeta; panicOnBuild?: boolean } {\n  const { input, pluginName, errorIdMap } = args || {}\n\n  // No component path passed\n  if (!input?.component) {\n    return {\n      error: {\n        id: errorIdMap.noPath,\n        context: {\n          pluginName,\n          input,\n        },\n      },\n    }\n  }\n\n  const componentPath = getPathToLayoutComponent(input?.component)\n\n  const errorContext = {\n    input,\n    pluginName,\n    componentPath,\n  }\n\n  // Component path already validated in previous pass\n  if (validationCache.has(componentPath)) {\n    return {}\n  }\n\n  // Component path must be absolute\n  if (!path.isAbsolute(componentPath)) {\n    return {\n      error: {\n        id: errorIdMap.notAbsolute,\n        context: errorContext,\n      },\n    }\n  }\n\n  // Component path must exist\n  if (isNotTestEnv) {\n    if (!fs.existsSync(componentPath)) {\n      return {\n        error: {\n          id: errorIdMap.doesNotExist,\n          context: errorContext,\n        },\n      }\n    }\n  }\n\n  if (!componentPath.includes(`/.cache/`) && isProductionEnv) {\n    const fileContent = fs.readFileSync(componentPath, `utf-8`)\n\n    // Component must not be empty\n    if (fileContent === ``) {\n      return {\n        error: {\n          id: errorIdMap.empty,\n          context: errorContext,\n        },\n        panicOnBuild: true,\n      }\n    }\n\n    // Component must have a default export\n    if ([`.js`, `.jsx`, `.ts`, `.tsx`].includes(path.extname(componentPath))) {\n      const includesDefaultExport =\n        fileContent.includes(`export default`) ||\n        fileContent.includes(`module.exports`) ||\n        fileContent.includes(`exports.default`) ||\n        fileContent.includes(`exports[\"default\"]`) ||\n        fileContent.match(/export \\{.* as default.*\\}/s) ||\n        fileContent.match(/export \\{\\s*default\\s*\\}/s)\n\n      if (!includesDefaultExport) {\n        return {\n          error: {\n            id: errorIdMap.noDefaultExport,\n            context: errorContext,\n          },\n          panicOnBuild: true,\n        }\n      }\n    }\n  }\n\n  validationCache.add(componentPath)\n  return {}\n}\n\nexport function clearValidationCache(): void {\n  validationCache.clear()\n}\n"],"mappings":"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"}