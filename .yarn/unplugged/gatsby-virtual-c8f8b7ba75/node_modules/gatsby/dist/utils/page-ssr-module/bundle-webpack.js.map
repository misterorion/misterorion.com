{"version":3,"file":"bundle-webpack.js","names":["extensions","outputDir","path","join","process","cwd","cacheLocation","writeQueryContext","staticQueriesByTemplate","components","waitingForWrites","pageTemplate","values","staticQueryHashes","get","componentPath","push","writeStaticQueryContext","componentChunkName","Promise","all","then","createPageSSRBundle","rootDir","webpackCompilationHash","reporter","isVerbose","state","store","getState","slicesStateObject","key","value","slices","slicesByTemplateStateObject","template","records","slicesByTemplate","recordsObject","Object","keys","webpackStats","readWebpackStats","toInline","query","assets","getScriptsAndStylesForTemplate","compiler","webpack","name","mode","entry","__dirname","output","filename","libraryTarget","target","externalsPresets","node","cache","type","buildDependencies","config","__filename","externals","mod","builtinModules","reduce","acc","builtinModule","devtool","module","rules","test","resolve","byDependency","esm","fullySpecified","parser","amd","use","loader","require","options","outputAssetBase","alias","inquirer","plugins","DefinePlugin","INLINED_TEMPLATE_TO_DETAILS","JSON","stringify","WEBPACK_COMPILATION_HASH","GATSBY_SLICES","GATSBY_SLICES_BY_TEMPLATE","GATSBY_SLICES_SCRIPT","env","fs","readFileSync","GATSBY_WEBPACK_LOGGING","includes","WebpackLoggingPlugin","filter","Boolean","reject","run","err","stats","close","closeErr","compilation"],"sources":["../../../src/utils/page-ssr-module/bundle-webpack.ts"],"sourcesContent":["import * as path from \"path\"\nimport * as fs from \"fs-extra\"\nimport webpack from \"webpack\"\nimport mod from \"module\"\nimport { WebpackLoggingPlugin } from \"../../utils/webpack/plugins/webpack-logging\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport type { ITemplateDetails } from \"./entry\"\n\nimport {\n  getScriptsAndStylesForTemplate,\n  readWebpackStats,\n} from \"../client-assets-for-template\"\nimport { writeStaticQueryContext } from \"../static-query-utils\"\nimport { IGatsbyState } from \"../../redux/types\"\nimport { store } from \"../../redux\"\n\ntype Reporter = typeof reporter\n\nconst extensions = [`.mjs`, `.js`, `.json`, `.node`, `.ts`, `.tsx`]\nconst outputDir = path.join(process.cwd(), `.cache`, `page-ssr`)\nconst cacheLocation = path.join(process.cwd(), `.cache`, `webpack`, `page-ssr`)\n\nexport async function writeQueryContext({\n  staticQueriesByTemplate,\n  components,\n}: {\n  staticQueriesByTemplate: IGatsbyState[\"staticQueriesByTemplate\"]\n  components: IGatsbyState[\"components\"]\n}): Promise<void> {\n  const waitingForWrites: Array<Promise<unknown>> = []\n  for (const pageTemplate of components.values()) {\n    const staticQueryHashes =\n      staticQueriesByTemplate.get(pageTemplate.componentPath) || []\n\n    waitingForWrites.push(\n      writeStaticQueryContext(\n        staticQueryHashes,\n        pageTemplate.componentChunkName\n      )\n    )\n  }\n\n  return Promise.all(waitingForWrites).then(() => {})\n}\n\nexport async function createPageSSRBundle({\n  rootDir,\n  components,\n  staticQueriesByTemplate,\n  webpackCompilationHash,\n  reporter,\n  isVerbose = false,\n}: {\n  rootDir: string\n  components: IGatsbyState[\"components\"]\n  staticQueriesByTemplate: IGatsbyState[\"staticQueriesByTemplate\"]\n  webpackCompilationHash: IGatsbyState[\"webpackCompilationHash\"]\n  reporter: Reporter\n  isVerbose?: boolean\n}): Promise<webpack.Compilation | undefined> {\n  const state = store.getState()\n  const slicesStateObject = {}\n  for (const [key, value] of state.slices) {\n    slicesStateObject[key] = value\n  }\n\n  const slicesByTemplateStateObject = {}\n  for (const [template, records] of state.slicesByTemplate) {\n    const recordsObject = {}\n    for (const path of Object.keys(records)) {\n      recordsObject[path] = records[path]\n    }\n\n    slicesByTemplateStateObject[template] = recordsObject\n  }\n\n  const webpackStats = await readWebpackStats(path.join(rootDir, `public`))\n\n  const toInline: Record<string, ITemplateDetails> = {}\n  for (const pageTemplate of components.values()) {\n    const staticQueryHashes =\n      staticQueriesByTemplate.get(pageTemplate.componentPath) || []\n\n    toInline[pageTemplate.componentChunkName] = {\n      query: pageTemplate.query,\n      staticQueryHashes,\n      assets: await getScriptsAndStylesForTemplate(\n        pageTemplate.componentChunkName,\n        webpackStats\n      ),\n    }\n  }\n\n  const compiler = webpack({\n    name: `Page Engine`,\n    mode: `none`,\n    entry: path.join(__dirname, `entry.js`),\n    output: {\n      path: outputDir,\n      filename: `index.js`,\n      libraryTarget: `commonjs`,\n    },\n    target: `node`,\n    externalsPresets: {\n      node: false,\n    },\n    cache: {\n      type: `filesystem`,\n      name: `page-ssr`,\n      cacheLocation,\n      buildDependencies: {\n        config: [__filename],\n      },\n    },\n    // those are required in some runtime paths, but we don't need them\n    externals: [\n      /^\\.\\/routes/,\n      `electron`, // :shrug: `got` seems to have electron specific code path\n      mod.builtinModules.reduce((acc, builtinModule) => {\n        if (builtinModule === `fs`) {\n          acc[builtinModule] = `global _actualFsWrapper`\n        } else {\n          acc[builtinModule] = `commonjs ${builtinModule}`\n        }\n\n        return acc\n      }, {}),\n    ],\n    devtool: false,\n    module: {\n      rules: [\n        {\n          test: /\\.m?js$/,\n          type: `javascript/auto`,\n          resolve: {\n            byDependency: {\n              esm: {\n                fullySpecified: false,\n              },\n            },\n          },\n        },\n        {\n          // For node binary relocations, include \".node\" files as well here\n          test: /\\.(m?js|node)$/,\n          // it is recommended for Node builds to turn off AMD support\n          parser: { amd: false },\n          use: {\n            loader: require.resolve(`@vercel/webpack-asset-relocator-loader`),\n            options: {\n              outputAssetBase: `assets`,\n            },\n          },\n        },\n        {\n          test: /\\.txt/,\n          type: `asset/resource`,\n        },\n      ],\n    },\n    resolve: {\n      extensions,\n      alias: {\n        \".cache\": `${rootDir}/.cache/`,\n        [require.resolve(`gatsby-cli/lib/reporter/loggers/ink/index.js`)]:\n          false,\n        inquirer: false,\n      },\n    },\n    plugins: [\n      new webpack.DefinePlugin({\n        INLINED_TEMPLATE_TO_DETAILS: JSON.stringify(toInline),\n        WEBPACK_COMPILATION_HASH: JSON.stringify(webpackCompilationHash),\n        GATSBY_SLICES: JSON.stringify(slicesStateObject),\n        GATSBY_SLICES_BY_TEMPLATE: JSON.stringify(slicesByTemplateStateObject),\n        GATSBY_SLICES_SCRIPT: JSON.stringify(\n          _CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES\n            ? fs.readFileSync(\n                path.join(\n                  rootDir,\n                  `public`,\n                  `_gatsby`,\n                  `slices`,\n                  `_gatsby-scripts-1.html`\n                ),\n                `utf-8`\n              )\n            : ``\n        ),\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        \"process.env.GATSBY_LOGGER\": JSON.stringify(`yurnalist`),\n        // eslint-disable-next-line @typescript-eslint/naming-convention\n        \"process.env.GATSBY_SLICES\": JSON.stringify(\n          !!process.env.GATSBY_SLICES\n        ),\n      }),\n      process.env.GATSBY_WEBPACK_LOGGING?.includes(`page-engine`)\n        ? new WebpackLoggingPlugin(rootDir, reporter, isVerbose)\n        : false,\n    ].filter(Boolean) as Array<webpack.WebpackPluginInstance>,\n  })\n\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats) => {\n      compiler.close(closeErr => {\n        if (err) {\n          return reject(err)\n        }\n        if (closeErr) {\n          return reject(closeErr)\n        }\n        return resolve(stats?.compilation)\n      })\n    })\n  })\n}\n"],"mappings":"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"}