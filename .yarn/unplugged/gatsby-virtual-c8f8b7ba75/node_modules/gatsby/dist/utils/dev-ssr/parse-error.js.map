{"version":3,"file":"parse-error.js","names":["getPosition","stackObject","filename","line","column","stackLine","splitLine","match","Number","err","parseError","directory","componentPath","htmlComponentRendererPath","createErrorFromString","stack","split","position","relativeFileName","startsWith","substring","sysPath","join","fs","existsSync","projectName","readJsonSync","name","sep","length","e","sourceContent","readFileSync","trueFileName","includes","slash","relative","message"],"sources":["../../../src/utils/dev-ssr/parse-error.ts"],"sourcesContent":["import { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport * as sysPath from \"path\"\nimport * as fs from \"fs-extra\"\nimport { slash } from \"gatsby-core-utils/path\"\n\nconst getPosition = function (stackObject: Array<string>): {\n  filename: string\n  line: number\n  column: number\n} {\n  let filename = ``\n  let line = 0\n  let column = 0\n  // Because the JavaScript error stack has not yet been standardized,\n  // wrap the stack parsing in a try/catch for a soft fail if an\n  // unexpected stack is encountered.\n  try {\n    for (const stackLine of stackObject) {\n      {\n        // testing for following format:\n        // \"    at Component (/Users/misiek/dev/gatsby/integration-tests/ssr/.cache/page-ssr/routes/render-page.js:4088:13)\"\n        const splitLine = stackLine.match(/(?:\\()(.+):([0-9]+):([0-9]+)(?:\\))$/)\n        if (splitLine) {\n          filename = splitLine[1]\n          line = Number(splitLine[2])\n          column = Number(splitLine[3])\n          break\n        }\n      }\n\n      {\n        // testing for following format:\n        // \"    at ssr/src/pages/bad-page.js:4:13\"\n        const splitLine = stackLine.match(/at (.+):([0-9]+):([0-9]+)$/)\n        if (splitLine) {\n          filename = splitLine[1]\n          line = Number(splitLine[2])\n          column = Number(splitLine[3])\n          break\n        }\n      }\n\n      {\n        // trying to extract generic:\n        // \"<filepath>:<line>:<column>\"\n        const splitLine = stackLine.match(/(.+):([0-9]+):([0-9]+)/)\n        if (splitLine) {\n          filename = splitLine[1]\n          line = Number(splitLine[2])\n          column = Number(splitLine[3])\n          break\n        }\n      }\n    }\n  } catch (err) {\n    filename = ``\n    line = 0\n    column = 0\n  }\n  return {\n    filename,\n    line,\n    column,\n  }\n}\n\nexport interface IParsedError {\n  filename: string\n  sourceContent: string\n  message: string\n  stack: string\n  line: number\n  column: number\n}\n\nexport interface IErrorRenderMeta {\n  codeFrame: string\n  source: string\n  line: number\n  column: number\n  sourceMessage?: string\n  stack?: string\n}\n\n// Code borrowed and modified from https://github.com/watilde/parse-error\nexport const parseError = function ({\n  err,\n  directory,\n  componentPath,\n  htmlComponentRendererPath,\n}: {\n  err: Error\n  directory: string\n  componentPath: string\n  htmlComponentRendererPath: string\n}): IParsedError {\n  // convert stack trace to use source file locations and not compiled ones\n  err = createErrorFromString(err, `${htmlComponentRendererPath}.map`)\n\n  const stack = err.stack ? err.stack : ``\n  const stackObject = stack.split(`\\n`)\n  const position = getPosition(stackObject)\n\n  let relativeFileName = position.filename\n  while (relativeFileName.startsWith(`/`)) {\n    relativeFileName = relativeFileName.substring(1)\n  }\n\n  let filename = sysPath.join(directory, relativeFileName)\n\n  // webpack tends to inject project name as first segment in stack traces\n  // so the filename / relativeFileName might not be correct - so we are checking\n  // if it points to existing file and try to remove project name if it's first segment\n  if (!fs.existsSync(filename)) {\n    try {\n      const projectName = fs.readJsonSync(\n        sysPath.join(directory, `package.json`),\n        `utf8`\n      ).name\n\n      if (relativeFileName.startsWith(projectName + sysPath.sep)) {\n        relativeFileName = relativeFileName.substring(\n          (projectName + sysPath.sep).length\n        )\n      }\n\n      filename = sysPath.join(directory, relativeFileName)\n    } catch (e) {\n      // nothing more we can do here\n    }\n  }\n\n  let sourceContent\n  try {\n    sourceContent = fs.readFileSync(filename, `utf-8`)\n  } catch (e) {\n    sourceContent = null\n  }\n\n  // We prefer the file path from the stack trace as the error might not be in the\n  // component â€” but if source-maps fail and we just get public/render-page.js as\n  // the file, we fall back on the component filepath as at least the user\n  // will have that.\n  const trueFileName = filename.includes(`render-page`)\n    ? componentPath\n    : filename\n\n  return {\n    filename: slash(sysPath.relative(directory, trueFileName)),\n    sourceContent,\n    message: err.message,\n    stack: stack,\n    line: position.line,\n    column: position.column,\n  }\n}\n"],"mappings":"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"}