{"version":3,"file":"build-html.js","names":["isPreview","process","env","GATSBY_IS_PREVIEW","devssrWebpackCompiler","SSRBundleReceivedInvalidEvent","SSRBundleWillInvalidate","devSSRWillInvalidate","activeRecompilations","getDevSSRWebpack","gatsby_executing_command","Error","watcher","compiler","recompileAndResumeWatching","allowTimedFallback","isResolved","Promise","resolve","stopWatching","suspend","timeout","finish","emitter","off","clearTimeout","on","resume","setTimeout","needToRecompileSSRBundle","oldHash","newHash","runWebpack","compilerConfig","stage","directory","isDevSSREnabledAndViable","GATSBY_EXPERIMENTAL_DEV_SSR","reject","webpack","hooks","invalid","tap","isFirstCompile","watch","ignored","err","stats","emit","hash","restartWorker","require","ROUTES_DIRECTORY","close","build","then","doBuildRenderer","webpackConfig","hasErrors","reporter","panicOnBuild","structureWebpackErrors","compilation","errors","rendererPath","doBuildPartialHydrationRenderer","buildRenderer","program","parentSpan","config","buildPartialHydrationRenderer","rule","module","rules","match","test","use","Array","isArray","push","loader","cache","output","path","join","alias","e","deleteRenderer","fs","remove","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","Stage","BuildHTML","envVars","NODE_ENV","gatsby_log_level","segments","sessionId","Date","now","webpackCompilationHash","store","getState","renderHTML","single","renderHTMLProd","renderHTMLDev","uniqueUnsafeBuiltinUsedStacks","Set","Bluebird","map","pageSegment","renderHTMLResult","paths","htmlRenderMeta","seenErrors","errorMessages","Map","all","Object","entries","previewErrors","pagePath","error","has","stack","set","pagePaths","add","prettyError","createErrorFromString","errorMessageStr","codeFrame","errorMessage","get","value","values","p","id","context","dispatch","type","payload","GATSBY_SLICES","slicesPropsPerPage","_pagePath","arrayOfUsages","unsafeBuiltinsUsageByPagePath","unsafeUsageStack","tick","length","size","console","warn","unsafeBuiltinUsedStack","warningMessage","renderPartialHydrationQueue","assetPrefix","pathPrefix","renderPartialHydrationProd","getPublicPath","BuildHTMLError","constructor","message","getOwnPropertyNames","forEach","key","truncateObjStrings","obj","doBuildPages","buildError","pageData","getPageData","truncatedPageData","pageDataMessage","JSON","stringify","buildHTML","GATSBY_PARTIAL_HYDRATION","buildHTMLPagesAndDeleteStaleArtifacts","buildUtils","markHtmlDirtyIfResultOfUsedStaticQueryChanged","toRegenerate","toDelete","toCleanupFromTrackedState","calcDirtyHtmlFiles","buildHTMLActivityProgress","createProgress","start","errorPath","undefinedGlobal","extractUndefinedGlobal","panic","end","info","keepPageRenderer","buildSlices","stitchSlicesIntoPagesHTML","publicDir","deletePageDataActivityTimer","activityTimer","removePageFiles","state","slicesProps","sliceId","props","sliceName","hasChildren","dirty","html","bySliceId","slices","from","renderSlices","stichSlicesActivity","pagesThatNeedToStitchSlices","stichQueue","fastq","cb","stitchSliceForAPage","page","getPageMode","idle","drain"],"sources":["../../src/commands/build-html.ts"],"sourcesContent":["import Bluebird from \"bluebird\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport { chunk, truncate } from \"lodash\"\nimport { build, watch } from \"../utils/webpack/bundle\"\nimport * as path from \"path\"\nimport fastq from \"fastq\"\n\nimport { emitter, store } from \"../redux\"\nimport webpack from \"webpack\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { structureWebpackErrors } from \"../utils/webpack-error-utils\"\nimport * as buildUtils from \"./build-utils\"\nimport { getPageData } from \"../utils/get-page-data\"\n\nimport { Span } from \"opentracing\"\nimport { IProgram, Stage } from \"./types\"\nimport { ROUTES_DIRECTORY } from \"../constants\"\nimport { PackageJson } from \"../..\"\nimport { IPageDataWithQueryResult } from \"../utils/page-data\"\nimport { getPublicPath } from \"../utils/get-public-path\"\n\nimport type { GatsbyWorkerPool } from \"../utils/worker/pool\"\nimport { stitchSliceForAPage } from \"../utils/slices/stitching\"\nimport type { ISlicePropsEntry } from \"../utils/worker/child/render-html\"\nimport { getPageMode } from \"../utils/page-mode\"\nimport { extractUndefinedGlobal } from \"../utils/extract-undefined-global\"\n\ntype IActivity = any // TODO\n\nconst isPreview = process.env.GATSBY_IS_PREVIEW === `true`\n\nexport interface IBuildArgs extends IProgram {\n  directory: string\n  sitePackageJson: PackageJson\n  prefixPaths: boolean\n  noUglify: boolean\n  logPages: boolean\n  writeToFile: boolean\n  profile: boolean\n  graphqlTracing: boolean\n  openTracingConfigFile: string\n  // TODO remove in v4\n  keepPageRenderer: boolean\n}\n\ninterface IBuildRendererResult {\n  rendererPath: string\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}\n\nlet devssrWebpackCompiler: webpack.Watching | undefined\nlet SSRBundleReceivedInvalidEvent = true\nlet SSRBundleWillInvalidate = false\n\nexport function devSSRWillInvalidate(): void {\n  // we only get one `invalid` callback, so if we already\n  // set this to true, we can't really await next `invalid` event\n  if (!SSRBundleReceivedInvalidEvent) {\n    SSRBundleWillInvalidate = true\n  }\n}\n\nlet activeRecompilations = 0\n\nexport const getDevSSRWebpack = (): {\n  recompileAndResumeWatching: (\n    allowTimedFallback: boolean\n  ) => Promise<() => void>\n  needToRecompileSSRBundle: boolean\n} => {\n  if (process.env.gatsby_executing_command !== `develop`) {\n    throw new Error(`This function can only be called in development`)\n  }\n\n  const watcher = devssrWebpackCompiler as webpack.Watching\n  const compiler = (devssrWebpackCompiler as webpack.Watching).compiler\n  if (watcher && compiler) {\n    return {\n      recompileAndResumeWatching: async function recompileAndResumeWatching(\n        allowTimedFallback: boolean\n      ): Promise<() => void> {\n        let isResolved = false\n        return await new Promise<() => void>(resolve => {\n          function stopWatching(): void {\n            activeRecompilations--\n            if (activeRecompilations === 0) {\n              watcher.suspend()\n            }\n          }\n          let timeout\n          function finish(): void {\n            emitter.off(`DEV_SSR_COMPILATION_DONE`, finish)\n            if (!isResolved) {\n              isResolved = true\n              resolve(stopWatching)\n            }\n            if (timeout) {\n              clearTimeout(timeout)\n            }\n          }\n          emitter.on(`DEV_SSR_COMPILATION_DONE`, finish)\n          // we reset it before we start compilation to be able to catch any invalid events\n          SSRBundleReceivedInvalidEvent = false\n          if (activeRecompilations === 0) {\n            watcher.resume()\n          }\n          activeRecompilations++\n\n          if (allowTimedFallback) {\n            // Timeout after 1.5s.\n            timeout = setTimeout(() => {\n              if (!isResolved) {\n                isResolved = true\n                resolve(stopWatching)\n              }\n            }, 1500)\n          }\n        })\n      },\n      needToRecompileSSRBundle:\n        SSRBundleReceivedInvalidEvent || SSRBundleWillInvalidate,\n    }\n  } else {\n    return {\n      needToRecompileSSRBundle: false,\n      recompileAndResumeWatching: (): Promise<() => void> =>\n        Promise.resolve((): void => {}),\n    }\n  }\n}\n\nlet oldHash = ``\nlet newHash = ``\nconst runWebpack = (\n  compilerConfig,\n  stage: Stage,\n  directory: string\n): Promise<{\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}> => {\n  const isDevSSREnabledAndViable =\n    process.env.GATSBY_EXPERIMENTAL_DEV_SSR && stage === `develop-html`\n\n  return new Promise((resolve, reject) => {\n    if (isDevSSREnabledAndViable) {\n      const compiler = webpack(compilerConfig)\n\n      // because of this line we can't use our watch helper\n      // These things should use emitter\n      compiler.hooks.invalid.tap(`ssr file invalidation`, () => {\n        SSRBundleReceivedInvalidEvent = true\n        SSRBundleWillInvalidate = false // we were waiting for this event, we are no longer waiting for it\n      })\n\n      let isFirstCompile = true\n      const watcher = compiler.watch(\n        {\n          ignored: /node_modules/,\n        },\n        (err, stats) => {\n          // this runs multiple times\n          emitter.emit(`DEV_SSR_COMPILATION_DONE`)\n          if (isFirstCompile) {\n            watcher.suspend()\n            isFirstCompile = false\n          }\n\n          if (err) {\n            return reject(err)\n          } else {\n            newHash = stats?.hash || ``\n\n            const {\n              restartWorker,\n            } = require(`../utils/dev-ssr/render-dev-html`)\n            // Make sure we use the latest version during development\n            if (oldHash !== `` && newHash !== oldHash) {\n              restartWorker(`${directory}/${ROUTES_DIRECTORY}render-page.js`)\n            }\n\n            oldHash = newHash\n\n            return resolve({\n              stats: stats as webpack.Stats,\n              close: () =>\n                new Promise((resolve, reject): void =>\n                  watcher.close(err => (err ? reject(err) : resolve()))\n                ),\n            })\n          }\n        }\n      )\n      devssrWebpackCompiler = watcher\n    } else {\n      build(compilerConfig).then(\n        ({ stats, close }) => {\n          resolve({ stats, close })\n        },\n        err => reject(err)\n      )\n    }\n  })\n}\n\nconst doBuildRenderer = async (\n  directory: string,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<IBuildRendererResult> => {\n  const { stats, close } = await runWebpack(webpackConfig, stage, directory)\n  if (stats?.hasErrors()) {\n    reporter.panicOnBuild(\n      structureWebpackErrors(stage, stats.compilation.errors)\n    )\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return {\n    rendererPath: `${directory}/${ROUTES_DIRECTORY}render-page.js`,\n    stats,\n    close,\n  }\n}\n\nconst doBuildPartialHydrationRenderer = async (\n  directory: string,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<IBuildRendererResult> => {\n  const { stats, close } = await runWebpack(webpackConfig, stage, directory)\n  if (stats?.hasErrors()) {\n    reporter.panicOnBuild(\n      structureWebpackErrors(stage, stats.compilation.errors)\n    )\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return {\n    rendererPath: `${directory}/${ROUTES_DIRECTORY}render-page.js`,\n    stats,\n    close,\n  }\n}\n\nexport const buildRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<IBuildRendererResult> => {\n  const config = await webpackConfig(program, program.directory, stage, null, {\n    parentSpan,\n  })\n\n  return doBuildRenderer(program.directory, config, stage)\n}\n\nexport const buildPartialHydrationRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<IBuildRendererResult> => {\n  const config = await webpackConfig(program, program.directory, stage, null, {\n    parentSpan,\n  })\n\n  for (const rule of config.module.rules) {\n    if (`./test.js`.match(rule.test)) {\n      if (!rule.use) {\n        rule.use = []\n      }\n      if (!Array.isArray(rule.use)) {\n        rule.use = [rule.use]\n      }\n      rule.use.push({\n        loader: require.resolve(\n          `../utils/webpack/loaders/partial-hydration-reference-loader`\n        ),\n      })\n    }\n  }\n\n  // TODO add caching\n  config.cache = false\n\n  config.output.path = path.join(\n    program.directory,\n    `.cache`,\n    `partial-hydration`\n  )\n\n  // require.resolve might fail the build if the package is not installed\n  // Instead of failing it'll be ignored\n  try {\n    // TODO collect javascript aliases to match the partial hydration bundle\n    config.resolve.alias[`gatsby-plugin-image`] = require.resolve(\n      `gatsby-plugin-image/dist/gatsby-image.browser.modern`\n    )\n  } catch (e) {\n    // do nothing\n  }\n\n  return doBuildPartialHydrationRenderer(program.directory, config, stage)\n}\n\n// TODO remove after v4 release and update cloud internals\nexport const deleteRenderer = async (rendererPath: string): Promise<void> => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\nexport interface IRenderHtmlResult {\n  unsafeBuiltinsUsageByPagePath: Record<string, Array<string>>\n  previewErrors: Record<string, any>\n\n  slicesPropsPerPage: Record<\n    string,\n    Record<\n      string,\n      {\n        props: Record<string, unknown>\n        sliceName: string\n        hasChildren: boolean\n      }\n    >\n  >\n}\n\nconst renderHTMLQueue = async (\n  workerPool: GatsbyWorkerPool,\n  activity: IActivity,\n  htmlComponentRendererPath: string,\n  pages: Array<string>,\n  stage: Stage = Stage.BuildHTML\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars: Array<[string, string | undefined]> = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n\n  const sessionId = Date.now()\n\n  const { webpackCompilationHash } = store.getState()\n\n  const renderHTML =\n    stage === `build-html`\n      ? workerPool.single.renderHTMLProd\n      : workerPool.single.renderHTMLDev\n\n  const uniqueUnsafeBuiltinUsedStacks = new Set<string>()\n\n  try {\n    await Bluebird.map(segments, async pageSegment => {\n      const renderHTMLResult = await renderHTML({\n        envVars,\n        htmlComponentRendererPath,\n        paths: pageSegment,\n        sessionId,\n        webpackCompilationHash,\n      })\n\n      if (isPreview) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        const seenErrors = new Set()\n        const errorMessages = new Map()\n        await Promise.all(\n          Object.entries(htmlRenderMeta.previewErrors).map(\n            async ([pagePath, error]) => {\n              if (!seenErrors.has(error.stack)) {\n                errorMessages.set(error.stack, {\n                  pagePaths: [pagePath],\n                })\n                seenErrors.add(error.stack)\n                const prettyError = createErrorFromString(\n                  error.stack,\n                  `${htmlComponentRendererPath}.map`\n                )\n\n                const errorMessageStr = `${prettyError.stack}${\n                  prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n                }`\n\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.errorMessage = errorMessageStr\n                errorMessages.set(error.stack, errorMessage)\n              } else {\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.pagePaths.push(pagePath)\n                errorMessages.set(error.stack, errorMessage)\n              }\n            }\n          )\n        )\n\n        for (const value of errorMessages.values()) {\n          const errorMessage = `The following page(s) saw this error when building their HTML:\\n\\n${value.pagePaths\n            .map(p => `- ${p}`)\n            .join(`\\n`)}\\n\\n${value.errorMessage}`\n          reporter.error({\n            id: `95314`,\n            context: { errorMessage },\n          })\n        }\n      }\n\n      if (stage === `build-html`) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        store.dispatch({\n          type: `HTML_GENERATED`,\n          payload: pageSegment,\n        })\n\n        if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n          store.dispatch({\n            type: `SET_SLICES_PROPS`,\n            payload: htmlRenderMeta.slicesPropsPerPage,\n          })\n        }\n\n        for (const [_pagePath, arrayOfUsages] of Object.entries(\n          htmlRenderMeta.unsafeBuiltinsUsageByPagePath\n        )) {\n          for (const unsafeUsageStack of arrayOfUsages) {\n            uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n          }\n        }\n      }\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  } catch (e) {\n    if (e?.context?.unsafeBuiltinsUsageByPagePath) {\n      for (const [_pagePath, arrayOfUsages] of Object.entries(\n        e.context.unsafeBuiltinsUsageByPagePath\n      )) {\n        // @ts-ignore TS doesn't know arrayOfUsages is Iterable\n        for (const unsafeUsageStack of arrayOfUsages) {\n          uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n        }\n      }\n    }\n    throw e\n  } finally {\n    if (uniqueUnsafeBuiltinUsedStacks.size > 0) {\n      console.warn(\n        `Unsafe builtin method was used, future builds will need to rebuild all pages`\n      )\n      store.dispatch({\n        type: `SSR_USED_UNSAFE_BUILTIN`,\n      })\n    }\n\n    for (const unsafeBuiltinUsedStack of uniqueUnsafeBuiltinUsedStacks) {\n      const prettyError = createErrorFromString(\n        unsafeBuiltinUsedStack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const warningMessage = `${prettyError.stack}${\n        prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n      }`\n\n      reporter.warn(warningMessage)\n    }\n  }\n}\n\nconst renderPartialHydrationQueue = async (\n  workerPool: GatsbyWorkerPool,\n  activity: IActivity,\n  pages: Array<string>,\n  program: IProgram\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars: Array<[string, string | undefined]> = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n  const sessionId = Date.now()\n\n  const { config } = store.getState()\n  const { assetPrefix, pathPrefix } = config\n\n  // Let the error bubble up\n  await Promise.all(\n    segments.map(async pageSegment => {\n      await workerPool.single.renderPartialHydrationProd({\n        envVars,\n        paths: pageSegment,\n        sessionId,\n        pathPrefix: getPublicPath({ assetPrefix, pathPrefix, ...program }),\n      })\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  )\n}\n\nclass BuildHTMLError extends Error {\n  codeFrame = ``\n  context?: {\n    path: string\n  }\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nconst truncateObjStrings = (obj): IPageDataWithQueryResult => {\n  // Recursively truncate strings nested in object\n  // These objs can be quite large, but we want to preserve each field\n  for (const key in obj) {\n    if (typeof obj[key] === `object`) {\n      truncateObjStrings(obj[key])\n    } else if (typeof obj[key] === `string`) {\n      obj[key] = truncate(obj[key], { length: 250 })\n    }\n  }\n\n  return obj\n}\n\nexport const doBuildPages = async (\n  rendererPath: string,\n  pagePaths: Array<string>,\n  activity: IActivity,\n  workerPool: GatsbyWorkerPool,\n  stage: Stage\n): Promise<void> => {\n  try {\n    await renderHTMLQueue(workerPool, activity, rendererPath, pagePaths, stage)\n  } catch (error) {\n    const prettyError = createErrorFromString(error, `${rendererPath}.map`)\n\n    const buildError = new BuildHTMLError(prettyError)\n    buildError.context = error.context\n\n    if (error?.context?.path) {\n      const pageData = await getPageData(error.context.path)\n      const truncatedPageData = truncateObjStrings(pageData)\n\n      const pageDataMessage = `Page data from page-data.json for the failed page \"${\n        error.context.path\n      }\": ${JSON.stringify(truncatedPageData, null, 2)}`\n\n      // This is our only error during preview so customize it a bit + add the\n      // pretty build error.\n      if (isPreview) {\n        reporter.error({\n          id: `95314`,\n          context: { pageData: pageDataMessage },\n          error: buildError,\n        })\n      } else {\n        reporter.error(pageDataMessage)\n      }\n    }\n\n    // Don't crash the builder when we're in preview-mode.\n    if (!isPreview) {\n      throw buildError\n    }\n  }\n}\n\n// TODO remove in v4 - this could be a \"public\" api\nexport const buildHTML = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}: {\n  program: IProgram\n  stage: Stage\n  pagePaths: Array<string>\n  activity: IActivity\n  workerPool: GatsbyWorkerPool\n}): Promise<void> => {\n  const rendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n  await doBuildPages(rendererPath, pagePaths, activity, workerPool, stage)\n\n  if (\n    (process.env.GATSBY_PARTIAL_HYDRATION === `true` ||\n      process.env.GATSBY_PARTIAL_HYDRATION === `1`) &&\n    _CFLAGS_.GATSBY_MAJOR === `5`\n  ) {\n    await renderPartialHydrationQueue(workerPool, activity, pagePaths, program)\n  }\n}\n\nexport async function buildHTMLPagesAndDeleteStaleArtifacts({\n  workerPool,\n  parentSpan,\n  program,\n}: {\n  workerPool: GatsbyWorkerPool\n  parentSpan?: Span\n  program: IBuildArgs\n}): Promise<{\n  toRegenerate: Array<string>\n  toDelete: Array<string>\n}> {\n  const rendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n  buildUtils.markHtmlDirtyIfResultOfUsedStaticQueryChanged()\n\n  const { toRegenerate, toDelete, toCleanupFromTrackedState } =\n    buildUtils.calcDirtyHtmlFiles(store.getState())\n\n  store.dispatch({\n    type: `HTML_TRACKED_PAGES_CLEANUP`,\n    payload: toCleanupFromTrackedState,\n  })\n\n  if (toRegenerate.length > 0) {\n    const buildHTMLActivityProgress = reporter.createProgress(\n      `Building static HTML for pages`,\n      toRegenerate.length,\n      0,\n      {\n        parentSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n    try {\n      await doBuildPages(\n        rendererPath,\n        toRegenerate,\n        buildHTMLActivityProgress,\n        workerPool,\n        Stage.BuildHTML\n      )\n    } catch (err) {\n      let id = `95313` // TODO: verify error IDs exist\n      const context = {\n        errorPath: err.context && err.context.path,\n        undefinedGlobal: ``,\n      }\n\n      const undefinedGlobal = extractUndefinedGlobal(err)\n\n      if (undefinedGlobal) {\n        id = `95312`\n        context.undefinedGlobal = undefinedGlobal\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context,\n        error: err,\n      })\n    }\n    buildHTMLActivityProgress.end()\n  } else {\n    reporter.info(`There are no new or changed html files to build.`)\n  }\n\n  if (\n    (process.env.GATSBY_PARTIAL_HYDRATION === `true` ||\n      process.env.GATSBY_PARTIAL_HYDRATION === `1`) &&\n    _CFLAGS_.GATSBY_MAJOR === `5`\n  ) {\n    if (toRegenerate.length > 0) {\n      const buildHTMLActivityProgress = reporter.createProgress(\n        `Building partial HTML for pages`,\n        toRegenerate.length,\n        0,\n        {\n          parentSpan,\n        }\n      )\n      try {\n        buildHTMLActivityProgress.start()\n        await renderPartialHydrationQueue(\n          workerPool,\n          buildHTMLActivityProgress,\n          toRegenerate,\n          program\n        )\n      } catch (error) {\n        // Generic error with page path and useful stack trace, accurate code frame can be a future improvement\n        buildHTMLActivityProgress.panic({\n          id: `80000`,\n          context: error.context,\n          error,\n        })\n      } finally {\n        buildHTMLActivityProgress.end()\n      }\n    }\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR !== `5` && !program.keepPageRenderer) {\n    try {\n      await deleteRenderer(rendererPath)\n    } catch (err) {\n      // pass through\n    }\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n    await buildSlices({\n      program,\n      workerPool,\n      parentSpan,\n    })\n\n    await stitchSlicesIntoPagesHTML({\n      publicDir: path.join(program.directory, `public`),\n      parentSpan,\n    })\n  }\n\n  if (toDelete.length > 0) {\n    const publicDir = path.join(program.directory, `public`)\n    const deletePageDataActivityTimer = reporter.activityTimer(\n      `Delete previous page data`\n    )\n    deletePageDataActivityTimer.start()\n    await buildUtils.removePageFiles(publicDir, toDelete)\n\n    deletePageDataActivityTimer.end()\n  }\n\n  return { toRegenerate, toDelete }\n}\n\nexport async function buildSlices({\n  program,\n  workerPool,\n  parentSpan,\n}: {\n  workerPool: GatsbyWorkerPool\n  parentSpan?: Span\n  program: IBuildArgs\n}): Promise<void> {\n  const state = store.getState()\n\n  // for now we always render everything, everytime\n  const slicesProps: Array<ISlicePropsEntry> = []\n  for (const [\n    sliceId,\n    { props, sliceName, hasChildren, pages, dirty },\n  ] of state.html.slicesProps.bySliceId.entries()) {\n    if (dirty && pages.size > 0) {\n      slicesProps.push({\n        sliceId,\n        props,\n        sliceName,\n        hasChildren,\n      })\n    }\n  }\n\n  if (slicesProps.length > 0) {\n    const buildHTMLActivityProgress = reporter.activityTimer(\n      `Building slices HTML (${slicesProps.length})`,\n      {\n        parentSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n\n    const htmlComponentRendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n    try {\n      const slices = Array.from(state.slices.entries())\n\n      await workerPool.single.renderSlices({\n        publicDir: path.join(program.directory, `public`),\n        htmlComponentRendererPath,\n        slices,\n        slicesProps,\n      })\n    } catch (err) {\n      const prettyError = createErrorFromString(\n        err.stack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const undefinedGlobal = extractUndefinedGlobal(err)\n\n      let id = `11339`\n\n      if (undefinedGlobal) {\n        id = `11340`\n        err.context.undefinedGlobal = undefinedGlobal\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context: err.context,\n        error: prettyError,\n      })\n    } finally {\n      buildHTMLActivityProgress.end()\n    }\n\n    // for now separate action for cleaning dirty flag and removing stale entries\n    store.dispatch({\n      type: `SLICES_PROPS_RENDERED`,\n      payload: slicesProps,\n    })\n  } else {\n    reporter.info(`There are no new or changed slice html files to build.`)\n  }\n\n  store.dispatch({\n    type: `SLICES_PROPS_REMOVE_STALE`,\n  })\n}\n\nexport async function stitchSlicesIntoPagesHTML({\n  publicDir,\n  parentSpan,\n}: {\n  publicDir: string\n  parentSpan?: Span\n}): Promise<void> {\n  const stichSlicesActivity = reporter.activityTimer(`stiching slices`, {\n    parentSpan,\n  })\n  stichSlicesActivity.start()\n  try {\n    const {\n      html: { pagesThatNeedToStitchSlices },\n      pages,\n    } = store.getState()\n\n    const stichQueue = fastq<void, string, void>(async (pagePath, cb) => {\n      await stitchSliceForAPage({ pagePath, publicDir })\n      cb(null)\n    }, 25)\n\n    for (const pagePath of pagesThatNeedToStitchSlices) {\n      const page = pages.get(pagePath)\n      if (!page) {\n        continue\n      }\n\n      if (getPageMode(page) === `SSG`) {\n        stichQueue.push(pagePath)\n      }\n    }\n\n    if (!stichQueue.idle()) {\n      await new Promise(resolve => {\n        stichQueue.drain = resolve as () => unknown\n      })\n    }\n\n    store.dispatch({ type: `SLICES_STITCHED` })\n  } finally {\n    stichSlicesActivity.end()\n  }\n}\n"],"mappings":"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"}