{"version":3,"file":"validate-page-component.js","names":["validationCache","Set","isNotTestEnv","process","env","NODE_ENV","isProductionEnv","validatePageComponent","page","directory","pluginName","component","Error","cleanComponentPath","getPathToLayoutComponent","has","path","isAbsolute","error","id","context","pageObject","message","fs","existsSync","includes","fileContent","readFileSync","relativePath","relative","panicOnBuild","extname","includesDefaultExport","match","fileName","add","clearValidationCache","clear"],"sources":["../../src/utils/validate-page-component.ts"],"sourcesContent":["import path from \"path\"\nimport fs from \"fs-extra\"\nimport { getPathToLayoutComponent } from \"gatsby-core-utils/parse-component-path\"\nimport { IGatsbyPage } from \"../redux/types\"\n\nconst validationCache = new Set<string>()\n\ninterface IErrorMeta {\n  id: string\n  context: Record<string, unknown>\n}\n\nconst isNotTestEnv = process.env.NODE_ENV !== `test`\nconst isProductionEnv = process.env.NODE_ENV === `production`\n\nexport function validatePageComponent(\n  page: IGatsbyPage,\n  directory: string,\n  pluginName: string\n): { message?: string; error?: IErrorMeta; panicOnBuild?: boolean } {\n  const { component } = page\n  if (!component) {\n    throw new Error(`11322`)\n  }\n\n  const cleanComponentPath = getPathToLayoutComponent(component)\n\n  if (validationCache.has(cleanComponentPath)) {\n    return {}\n  }\n  if (!path.isAbsolute(cleanComponentPath)) {\n    return {\n      error: {\n        id: `11326`,\n        context: {\n          pluginName,\n          pageObject: page,\n          component: cleanComponentPath,\n        },\n      },\n      message: `${pluginName} must set the absolute path to the page component when create creating a page`,\n    }\n  }\n\n  if (isNotTestEnv) {\n    if (!fs.existsSync(cleanComponentPath)) {\n      return {\n        error: {\n          id: `11325`,\n          context: {\n            pluginName,\n            pageObject: page,\n            component: cleanComponentPath,\n          },\n        },\n      }\n    }\n  }\n\n  // Validate that the page component imports React and exports something\n  // (hopefully a component).\n  //\n\n  if (!cleanComponentPath.includes(`/.cache/`) && isProductionEnv) {\n    const fileContent = fs.readFileSync(cleanComponentPath, `utf-8`)\n\n    if (fileContent === ``) {\n      const relativePath = path.relative(directory, cleanComponentPath)\n\n      return {\n        error: {\n          id: `11327`,\n          context: {\n            relativePath,\n          },\n        },\n        panicOnBuild: true,\n      }\n    }\n\n    // this check only applies to js and ts, not mdx\n    if (\n      [`.js`, `.jsx`, `.ts`, `.tsx`].includes(path.extname(cleanComponentPath))\n    ) {\n      const includesDefaultExport =\n        fileContent.includes(`export default`) ||\n        fileContent.includes(`module.exports`) ||\n        fileContent.includes(`exports.default`) ||\n        fileContent.includes(`exports[\"default\"]`) ||\n        fileContent.match(/export \\{.* as default.*\\}/s) ||\n        fileContent.match(/export \\{\\s*default\\s*\\}/s)\n\n      if (!includesDefaultExport) {\n        return {\n          error: {\n            id: `11328`,\n            context: {\n              fileName: cleanComponentPath,\n            },\n          },\n          panicOnBuild: true,\n        }\n      }\n    }\n  }\n\n  validationCache.add(cleanComponentPath)\n  return {}\n}\n\nexport function clearValidationCache(): void {\n  validationCache.clear()\n}\n"],"mappings":";;;;;;;;AAAA;;AACA;;AACA;;AAGA,MAAMA,eAAe,GAAG,IAAIC,GAAJ,EAAxB;AAOA,MAAMC,YAAY,GAAGC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAA0B,MAA/C;AACA,MAAMC,eAAe,GAAGH,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAA0B,YAAlD;;AAEO,SAASE,qBAAT,CACLC,IADK,EAELC,SAFK,EAGLC,UAHK,EAI6D;EAClE,MAAM;IAAEC;EAAF,IAAgBH,IAAtB;;EACA,IAAI,CAACG,SAAL,EAAgB;IACd,MAAM,IAAIC,KAAJ,CAAW,OAAX,CAAN;EACD;;EAED,MAAMC,kBAAkB,GAAG,IAAAC,4CAAA,EAAyBH,SAAzB,CAA3B;;EAEA,IAAIX,eAAe,CAACe,GAAhB,CAAoBF,kBAApB,CAAJ,EAA6C;IAC3C,OAAO,EAAP;EACD;;EACD,IAAI,CAACG,aAAA,CAAKC,UAAL,CAAgBJ,kBAAhB,CAAL,EAA0C;IACxC,OAAO;MACLK,KAAK,EAAE;QACLC,EAAE,EAAG,OADA;QAELC,OAAO,EAAE;UACPV,UADO;UAEPW,UAAU,EAAEb,IAFL;UAGPG,SAAS,EAAEE;QAHJ;MAFJ,CADF;MASLS,OAAO,EAAG,GAAEZ,UAAW;IATlB,CAAP;EAWD;;EAED,IAAIR,YAAJ,EAAkB;IAChB,IAAI,CAACqB,gBAAA,CAAGC,UAAH,CAAcX,kBAAd,CAAL,EAAwC;MACtC,OAAO;QACLK,KAAK,EAAE;UACLC,EAAE,EAAG,OADA;UAELC,OAAO,EAAE;YACPV,UADO;YAEPW,UAAU,EAAEb,IAFL;YAGPG,SAAS,EAAEE;UAHJ;QAFJ;MADF,CAAP;IAUD;EACF,CAtCiE,CAwClE;EACA;EACA;;;EAEA,IAAI,CAACA,kBAAkB,CAACY,QAAnB,CAA6B,UAA7B,CAAD,IAA4CnB,eAAhD,EAAiE;IAC/D,MAAMoB,WAAW,GAAGH,gBAAA,CAAGI,YAAH,CAAgBd,kBAAhB,EAAqC,OAArC,CAApB;;IAEA,IAAIa,WAAW,KAAM,EAArB,EAAwB;MACtB,MAAME,YAAY,GAAGZ,aAAA,CAAKa,QAAL,CAAcpB,SAAd,EAAyBI,kBAAzB,CAArB;;MAEA,OAAO;QACLK,KAAK,EAAE;UACLC,EAAE,EAAG,OADA;UAELC,OAAO,EAAE;YACPQ;UADO;QAFJ,CADF;QAOLE,YAAY,EAAE;MAPT,CAAP;IASD,CAf8D,CAiB/D;;;IACA,IACE,CAAE,KAAF,EAAS,MAAT,EAAiB,KAAjB,EAAwB,MAAxB,EAA+BL,QAA/B,CAAwCT,aAAA,CAAKe,OAAL,CAAalB,kBAAb,CAAxC,CADF,EAEE;MACA,MAAMmB,qBAAqB,GACzBN,WAAW,CAACD,QAAZ,CAAsB,gBAAtB,KACAC,WAAW,CAACD,QAAZ,CAAsB,gBAAtB,CADA,IAEAC,WAAW,CAACD,QAAZ,CAAsB,iBAAtB,CAFA,IAGAC,WAAW,CAACD,QAAZ,CAAsB,oBAAtB,CAHA,IAIAC,WAAW,CAACO,KAAZ,CAAkB,6BAAlB,CAJA,IAKAP,WAAW,CAACO,KAAZ,CAAkB,2BAAlB,CANF;;MAQA,IAAI,CAACD,qBAAL,EAA4B;QAC1B,OAAO;UACLd,KAAK,EAAE;YACLC,EAAE,EAAG,OADA;YAELC,OAAO,EAAE;cACPc,QAAQ,EAAErB;YADH;UAFJ,CADF;UAOLiB,YAAY,EAAE;QAPT,CAAP;MASD;IACF;EACF;;EAED9B,eAAe,CAACmC,GAAhB,CAAoBtB,kBAApB;EACA,OAAO,EAAP;AACD;;AAEM,SAASuB,oBAAT,GAAsC;EAC3CpC,eAAe,CAACqC,KAAhB;AACD"}