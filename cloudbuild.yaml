steps:
  - id: Fetch Content Submodule
    name: gcr.io/cloud-builders/git
    script: |
      git init
      git config -f .gitmodules submodule.content.url $CONTENT_REPO
      git submodule init
      git submodule update
    env: ["GIT_DISCOVERY_ACROSS_FILESYSTEM=1", "CONTENT_REPO=$_CONTENT_REPO"]
  - id: Install
    name: gcr.io/cloud-builders/npm
    args: ["ci"]
  - id: Build
    name: gcr.io/cloud-builders/npm
    script: |
      PUBLIC_BASIC_AUTH=$_BASIC_AUTH npm run build
  - id: Sync
    name: gcr.io/cloud-builders/gcloud
    entrypoint: sh
    script: |
      mkdir empty
      gsutil -q -m rsync -R -d empty gs://$_WEBSITE_BUCKET
      echo Syncing website content ...
      gsutil -q -m cp -R dist/* gs://$_WEBSITE_BUCKET
      gsutil -q -m setmeta -h "Cache-Control:public,max-age=86400" gs://$_WEBSITE_BUCKET/**
      gsutil -q -m setmeta -h "Cache-Control:public,max-age=31536000" gs://$_WEBSITE_BUCKET/_astro/**
      echo Done!
  - id: Bust Cache
    name: gcr.io/cloud-builders/gcloud
    args:
      [
        "compute",
        "url-maps",
        "invalidate-cdn-cache",
        $_LB_NAME,
        "--global",
        "--host",
        $_LB_HOST,
        "--path",
        "/*",
        "--async",
      ]
