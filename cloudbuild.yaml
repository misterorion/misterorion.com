steps:
- name: 'gcr.io/cloud-builders/docker'
  entrypoint: 'bash'
  args: ['-c', 'docker pull $_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:latest || exit 0']
- name: 'gcr.io/cloud-builders/docker'
  args: [
          'build',
          '-t', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:latest',
          '--cache-from', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:latest',
          '.'
        ]
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args: [
          'run',
          'deploy', '$_SERVICE_NAME',
          '--image', '$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:latest',
          '--region', '$_DEPLOY_REGION',
          '--platform', 'managed'
        ]
images: ['$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:latest']
