steps:
  - id: Yarn build
    name: $_NODE_IMAGE
    entrypoint: yarn
    args:
      - build
    env:
      - GATSBY_BASIC_AUTH=${_GATSBY_BASIC_AUTH}
      - GATSBY_LOGGER=yurnalist
      - GATSBY_TELEMETRY_DISABLED=true
  - id: Precompress files
    name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    args:
      - -c
      - |
        gsutil -q -m cp $_BROTLI_BIN brotli.tar.gz && tar -zxf brotli.tar.gz
        find ./public -type f -size +1400c \
          -regex ".*\.\(css\|html\|js\|json\|svg\|xml\)$" \
          -exec ./brotli --best {} \+ \
          -exec gzip --best -k {} \+
  - id: Build and push image
    name: gcr.io/cloud-builders/docker
    entrypoint: bash
    args:
      - -c
      - |
        docker build --build-arg CADDY_IMAGE=$_CADDY_IMAGE -t $_APP_IMAGE:$SHORT_SHA .
        docker push $_APP_IMAGE:$SHORT_SHA
  - id: Deploy
    name: gcr.io/cloud-builders/gcloud
    entrypoint: bash
    args:
      - -c
      - |
        gcloud run deploy $_SERVICE_NA_EAST --image $_APP_IMAGE:$SHORT_SHA --async --region us-east4
        gcloud run deploy $_SERVICE_NA_CENTRAL --image $_APP_IMAGE:$SHORT_SHA --async --region us-central1
        gcloud run deploy $_SERVICE_NA_WEST --image $_APP_IMAGE:$SHORT_SHA --async --region us-west1
        gcloud run deploy $_SERVICE_EU --image $_APP_IMAGE:$SHORT_SHA --async --region europe-west1
        gcloud run deploy $_SERVICE_AP --image $_APP_IMAGE:$SHORT_SHA --async --region asia-northeast1
        gcloud run deploy $_SERVICE_SA --image $_APP_IMAGE:$SHORT_SHA --async --region southamerica-east1
